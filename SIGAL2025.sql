CREATE DATABASE SIGAL;
USE SIGAL;
-- TABLA PERSONAS 
CREATE TABLE PERSONAS(
	COD_PERSONA INT PRIMARY KEY AUTO_INCREMENT,
	PRIMER_NOMBRE VARCHAR(30) NOT NULL,
	SEGUNDO_NOMBRE VARCHAR(30) NULL,
	PRIMER_APELLIDO VARCHAR(30) NOT NULL,
	SEGUNDO_APELLIDO VARCHAR(30) NULL,
	NUMERO_IDENTIDAD VARCHAR(16) NULL UNIQUE,
	RTN VARCHAR(16) NULL UNIQUE
);

-- TABLA CLIENTES
CREATE TABLE CLIENTES(
	COD_CLIENTE INT PRIMARY KEY AUTO_INCREMENT,
    COD_PERSONA INT NOT NULL,
    PRIMER_NOMBRE_C VARCHAR(100) NOT NULL,
    SEGUNDO_NOMBRE_C VARCHAR(100) NOT NULL,
    PRIMER_APELLIDO_C VARCHAR(100) NOT NULL,
    SEGUNDO_APELLIDO_C VARCHAR(100) NOT NULL,
	FOREIGN KEY (COD_PERSONA) REFERENCES PERSONAS(COD_PERSONA)
);

-- TABLA EMPLEADOS 
CREATE TABLE EMPLEADOS(
	COD_EMPLEADO INT PRIMARY KEY AUTO_INCREMENT,
    COD_PERSONA INT NOT NULL,
	PRIMER_NOMBRE_E VARCHAR(100) NOT NULL,
    SEGUNDO_NOMBRE_E VARCHAR(100) NOT NULL,
    PRIMER_APELLIDO_E VARCHAR(100) NOT NULL,
    SEGUNDO_APELLIDO_E VARCHAR(100) NOT NULL,
    PUESTO ENUM('ADMINISTRADOR', 'VENDEDOR', 'GERENTE', 'JEFE PRODUCCION', 'JEFE DE VENTAS'),
	FOREIGN KEY (COD_PERSONA) REFERENCES PERSONAS(COD_PERSONA)
);


-- TABLA PROVEEDORES 
CREATE TABLE PROVEEDORES(
	COD_PROVEEDORES INT PRIMARY KEY AUTO_INCREMENT,
    COD_PERSONA INT NOT NULL,
	NOMBRE_EMPRESA VARCHAR(30) NOT NULL,
	NOMBRE_CONTACTO VARCHAR(30) NOT NULL,
    APELLIDO_CONTACTO VARCHAR(30) NOT NULL,
    FOREIGN KEY (COD_PERSONA) REFERENCES PERSONAS(COD_PERSONA)
);

-- TABLA DIRECCIONES 
CREATE TABLE DIRECCIONES(
	COD_DIRECCION INT PRIMARY KEY AUTO_INCREMENT,
    COD_PERSONA INT NOT NULL,
	CALLE VARCHAR(50) NOT NULL,
    CIUDAD VARCHAR(50) NOT NULL, 
    PAIS VARCHAR(50) NOT NULL,
    CODIGO_POSTAL VARCHAR(50),
    TIPO ENUM('DOMICILIO', 'LABORAL', 'OTRO'),
    FOREIGN KEY (COD_PERSONA) REFERENCES PERSONAS(COD_PERSONA)
);

-- TABLA CORREOS
CREATE TABLE CORREOS(
	COD_CORREO INT PRIMARY KEY AUTO_INCREMENT,
    COD_PERSONA INT NOT NULL,
    CORREO_ELECTRONICO VARCHAR(30) NOT NULL UNIQUE,
    TIPO ENUM('PERSONAL', 'LABORAL', 'OTRO'),
    FOREIGN KEY (COD_PERSONA) REFERENCES PERSONAS(COD_PERSONA)
);

-- TABLA TELEFONO
CREATE TABLE TELEFONOS(
	COD_TELEFONO INT PRIMARY KEY AUTO_INCREMENT,
    COD_PERSONA INT NOT NULL,
    NUMERO_TELEFONO VARCHAR(15) NOT NULL UNIQUE,
    TIPO_TELEFONO ENUM('PERSONAL', 'LABORAL', 'OTRO'),
    FOREIGN KEY (COD_PERSONA) REFERENCES PERSONAS(COD_PERSONA)
);

-- TABLA ROLES
CREATE TABLE ROLES(
	COD_ROL BIGINT PRIMARY KEY AUTO_INCREMENT,
	NOMBRE_ROL VARCHAR(255) NOT NULL,
	DESCRIPCION_ROL VARCHAR(255),
    ESTADO_ROL ENUM('1', '0') DEFAULT '1',
	USUARIO_CREA VARCHAR(255),
    FECHA_CREA DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- TABLA USUARIOS 
CREATE TABLE USUARIOS(
	COD_USUARIO BIGINT PRIMARY KEY AUTO_INCREMENT,
    COD_PERSONA BIGINT,
    COD_EMPLEADO INT,
    COD_ROL BIGINT,
    NOMBRE_USUARIO VARCHAR(255) NOT NULL,
    CONTRASENA VARCHAR(2000) NOT NULL,
    ESTADO_USUARIO ENUM('1', '0') DEFAULT '1',
    PERMISO_INSERCION ENUM('1', '0') DEFAULT '1',
    USUARIO_CREA VARCHAR(255),
    FECHA_CREA DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (COD_EMPLEADO) REFERENCES EMPLEADOS(COD_EMPLEADO),
    FOREIGN KEY (COD_ROL) REFERENCES ROLES(COD_ROL)
);


-- TABLA SESSIONES --
CREATE TABLE SESIONES (
    COD_SESION BIGINT PRIMARY KEY AUTO_INCREMENT,
    COD_USUARIO BIGINT NOT NULL,
    TOKEN VARCHAR(500) NOT NULL,
    FECHA_CREACION DATETIME DEFAULT CURRENT_TIMESTAMP,
    FECHA_EXPIRACION DATETIME NULL,
    FOREIGN KEY (COD_USUARIO) REFERENCES USUARIOS(COD_USUARIO)
);

CREATE TABLE SESIONES_RECUPERACION (
    ID INT PRIMARY KEY AUTO_INCREMENT,
    CODIGO VARCHAR(6) NOT NULL,
    COD_USUARIO BIGINT NOT NULL,
    FECHA_EXPIRACION DATETIME NOT NULL,
    FOREIGN KEY (COD_USUARIO) REFERENCES USUARIOS(COD_USUARIO)
);

-- TABLA INTENTOS
CREATE TABLE INTENTOS_FALLIDOS (
    COD_INTENTO BIGINT PRIMARY KEY AUTO_INCREMENT,
    COD_USUARIO BIGINT NULL,
    NOMBRE_USUARIO VARCHAR(255) NOT NULL,
    IP VARCHAR(50),
    FECHA DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (COD_USUARIO) REFERENCES USUARIOS(COD_USUARIO) ON DELETE SET NULL
);


-- TABLA OBJETOS 
CREATE TABLE OBJETOS (
    COD_OBJETO BIGINT PRIMARY KEY AUTO_INCREMENT,
    NOMBRE_OBJETO VARCHAR(255) NOT NULL,
    TIPO_OBJETO VARCHAR(255),
    DESCRIPCION_OBJETO VARCHAR(255),
    ESTADO_OBJETO ENUM('1', '0') DEFAULT '1',
    USUARIO_CREA VARCHAR(255),
    FECHA_CREA DATETIME DEFAULT CURRENT_TIMESTAMP
);



-- TABLA ACCESOS
CREATE TABLE ACCESOS (
    COD_ACCESO BIGINT PRIMARY KEY AUTO_INCREMENT,
    COD_ROL BIGINT,
    COD_OBJETO BIGINT,
    ESTADO_MODULO ENUM('1', '0') DEFAULT '1',
    ESTADO_SELECCION ENUM('1', '0') DEFAULT '1',
    ESTADO_INSERCION ENUM('1', '0') DEFAULT '1',
    ESTADO_ACTUALIZACION ENUM('1', '0') DEFAULT '1',
    ESTADO_ELIMINACION ENUM('1', '0') DEFAULT '1',
    USUARIO_CREA VARCHAR(255),
    FECHA_CREA DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (COD_ROL) REFERENCES ROLES(COD_ROL),
    FOREIGN KEY (COD_OBJETO) REFERENCES OBJETOS(COD_OBJETO)
);




-- TABLA HISTORIAL CONTRASEÑA
CREATE TABLE HISTCONTRASENA (
    COD_HISTCONTRASENA BIGINT PRIMARY KEY AUTO_INCREMENT,
    COD_USUARIO BIGINT NOT NULL,
    CONTRASENA TEXT NOT NULL,
    FECHA_CREA DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (COD_USUARIO) REFERENCES USUARIOS(COD_USUARIO)
);

-- TABLA PARAMETROS 
CREATE TABLE PARAMETROS (
    COD_PARAMETRO BIGINT PRIMARY KEY AUTO_INCREMENT,
    PARAMETRO VARCHAR(50) NOT NULL,
    VALOR VARCHAR(255) NOT NULL,
    COD_USUARIO BIGINT NOT NULL,
    FECHA_CREADO DATETIME DEFAULT CURRENT_TIMESTAMP,
    FECHA_MODIFICADO DATETIME DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (COD_USUARIO) REFERENCES USUARIOS(COD_USUARIO)
);

-- TABLA MATERIALES
CREATE TABLE MATERIALES (
    COD_MATERIAL INT PRIMARY KEY AUTO_INCREMENT,
    CODIGO VARCHAR(10) UNIQUE NOT NULL,
    MATERIAL VARCHAR(30) NOT NULL
);

-- TABLA INVENTARIO MATERIALES 
CREATE TABLE INVENTARIOMATERIALES (
    COD_INVMATERIAL INT PRIMARY KEY AUTO_INCREMENT,
    MATERIAL_CODIGO VARCHAR(10) UNIQUE NOT NULL,
    STOCK_ACTUAL DECIMAL(10,2) NOT NULL DEFAULT 0,
    STOCK_MINIMO DECIMAL(10,2) NOT NULL DEFAULT 0,
    FOREIGN KEY (MATERIAL_CODIGO) REFERENCES MATERIALES(CODIGO) ON UPDATE CASCADE
);

-- TABLA FACTURA COMPRA 
CREATE TABLE FACTURASCOMPRA (
    COD_FACTURA INT PRIMARY KEY AUTO_INCREMENT,
    NUMERO_FACTURA VARCHAR(10) UNIQUE NOT NULL,
    COD_PROVEEDORES INT NOT NULL,
    FECHA TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    SUBTOTAL DECIMAL(10,2) DEFAULT 0, 
    IMPUESTO DECIMAL(10,2) DEFAULT 0,
    DESCUENTO DECIMAL(10,2) DEFAULT 0,
    TOTAL DECIMAL(10,2) GENERATED ALWAYS AS (SUBTOTAL - (SUBTOTAL * DESCUENTO) + ((SUBTOTAL - (SUBTOTAL * DESCUENTO)) * IMPUESTO))  STORED,
    FOREIGN KEY (COD_PROVEEDORES) REFERENCES PROVEEDORES(COD_PROVEEDORES) ON UPDATE CASCADE
);

-- TABLA SUCURSALES
CREATE TABLE SUCURSALES (
    COD_SUCURSAL INT PRIMARY KEY AUTO_INCREMENT,
    NOMBRE VARCHAR(50) NOT NULL,
    DIRECCION VARCHAR(100) NOT NULL,
    COD_EMPLEADO_ENCARGADO INT,
    FOREIGN KEY (COD_EMPLEADO_ENCARGADO) REFERENCES EMPLEADOS(COD_EMPLEADO)
);


CREATE TABLE estado_sucursales (
    ID_ESTADO INT AUTO_INCREMENT PRIMARY KEY,
    COD_SUCURSAL INT NOT NULL,
    ESTADO ENUM('ACTIVA', 'INACTIVA') NOT NULL DEFAULT 'ACTIVA',
    FOREIGN KEY (COD_SUCURSAL) REFERENCES sucursales(COD_SUCURSAL) ON DELETE CASCADE
);

-- TABLA CATEGORIAS DE PRODUCTOS
CREATE TABLE CATEGORIAS (
    COD_CATEGORIA INT PRIMARY KEY AUTO_INCREMENT,
    NOMBRE VARCHAR(50) NOT NULL,
    DESCRIPCION VARCHAR(100)
);

-- TABLA PRODUCTOS
CREATE TABLE PRODUCTOS (
    COD_PRODUCTO INT PRIMARY KEY AUTO_INCREMENT,
    CODIGO VARCHAR(15) UNIQUE NOT NULL,
    MODELO VARCHAR(50) NOT NULL,
    DESCRIPCION VARCHAR(200),
    COD_CATEGORIA INT NOT NULL,
    TIEMPO_GARANTIA INT DEFAULT 0, -- En meses
    FOREIGN KEY (COD_CATEGORIA) REFERENCES CATEGORIAS(COD_CATEGORIA)
);


-- TABLA DETALLE DE COMPRA 
CREATE TABLE DETALLECOMPRA (
    COD_DETALLE_COMPRA INT PRIMARY KEY AUTO_INCREMENT,
    CODIGO_FACTURA INT NOT NULL,
    MATERIAL_CODIGO VARCHAR(10) NOT NULL,
    CANTIDAD DECIMAL(10,2) NOT NULL,
    PRECIO DECIMAL(10,2) NOT NULL,
    SUBTOTAL DECIMAL(10,2) GENERATED ALWAYS AS (CANTIDAD * PRECIO) STORED,
    FOREIGN KEY (CODIGO_FACTURA) REFERENCES FACTURASCOMPRA (COD_FACTURA),
    FOREIGN KEY (MATERIAL_CODIGO) REFERENCES MATERIALES(CODIGO) ON UPDATE CASCADE
);


-- TABLA INVENTARIO DE PRODUCTOS POR SUCURSAL
CREATE TABLE INVENTARIOPRODUCTOS (
    COD_INVENTARIO INT PRIMARY KEY AUTO_INCREMENT,
    COD_PRODUCTO INT NOT NULL,
    COD_SUCURSAL INT NOT NULL,
    STOCK_ACTUAL DECIMAL(10,2) NOT NULL DEFAULT 0,
    STOCK_MINIMO DECIMAL(10,2) NOT NULL DEFAULT 0,
    PRECIO_VENTA DECIMAL(10,2) NOT NULL DEFAULT 0, -- Precio por sucursal
    FOREIGN KEY (COD_PRODUCTO) REFERENCES PRODUCTOS(COD_PRODUCTO),
    FOREIGN KEY (COD_SUCURSAL) REFERENCES SUCURSALES(COD_SUCURSAL),
    UNIQUE KEY (COD_PRODUCTO, COD_SUCURSAL) -- Un producto solo puede tener un registro por sucursal
);
-- TABLA TRASLADOS ENTRE SUCURSALES
CREATE TABLE TRASLADOS (
    COD_TRASLADO INT PRIMARY KEY AUTO_INCREMENT,
    COD_USUARIO BIGINT NOT NULL,
    SUCURSAL_ORIGEN INT NOT NULL,
    SUCURSAL_DESTINO INT NOT NULL,
    FECHA_TRASLADO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ESTADO ENUM('PENDIENTE', 'EN TRANSITO', 'COMPLETADO', 'CANCELADO') DEFAULT 'PENDIENTE',
    NOTAS VARCHAR(200),
    FOREIGN KEY (SUCURSAL_ORIGEN) REFERENCES SUCURSALES(COD_SUCURSAL),
    FOREIGN KEY (COD_USUARIO) REFERENCES USUARIOS(COD_USUARIO),
    FOREIGN KEY (SUCURSAL_DESTINO) REFERENCES SUCURSALES(COD_SUCURSAL)
);

-- TABLA DETALLE DE TRASLADOS
CREATE TABLE DETALLETRASLADOS (
    COD_DETALLE_TRASLADO INT PRIMARY KEY AUTO_INCREMENT,
    COD_TRASLADO INT NOT NULL,
    COD_PRODUCTO INT NOT NULL,
    CANTIDAD DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (COD_TRASLADO) REFERENCES TRASLADOS(COD_TRASLADO),
    FOREIGN KEY (COD_PRODUCTO) REFERENCES PRODUCTOS(COD_PRODUCTO)
);


-- PROCEDIMIENTO CLIENTE 
-- INSERTAR CLIENTE
DELIMITER //
CREATE PROCEDURE sp_InsertarCliente(
    IN P_PRIMER_NOMBRE_C VARCHAR(100), 
    IN P_SEGUNDO_NOMBRE_C VARCHAR(100),
    IN P_PRIMER_APELLIDO_C VARCHAR(100), 
    IN P_SEGUNDO_APELLIDO_C VARCHAR(100),
    IN P_NUMERO_IDENTIDAD VARCHAR(16),
    IN P_RTN VARCHAR(16),
    IN P_NUMERO_TELEFONO VARCHAR(15), 
    IN P_TIPO_TELEFONO ENUM('PERSONAL', 'LABORAL', 'OTRO'),
    IN P_CORREO_ELECTRONICO VARCHAR(30), 
    IN P_TIPO_CORREO ENUM('PERSONAL', 'LABORAL', 'OTRO'),
    IN P_CALLE VARCHAR(50), 
    IN P_CIUDAD VARCHAR(50), 
    IN P_PAIS VARCHAR(50), 
    IN P_CODIGO_POSTAL VARCHAR(50),
    IN P_TIPO_DIRECCION ENUM('DOMICILIO', 'LABORAL', 'OTRO')
)
BEGIN
    DECLARE V_COD_PERSONA INT;
    
    INSERT INTO PERSONAS (PRIMER_NOMBRE, SEGUNDO_NOMBRE, PRIMER_APELLIDO, SEGUNDO_APELLIDO, NUMERO_IDENTIDAD, RTN)
    VALUES (P_PRIMER_NOMBRE_C, P_SEGUNDO_NOMBRE_C, P_PRIMER_APELLIDO_C, P_SEGUNDO_APELLIDO_C, P_NUMERO_IDENTIDAD, P_RTN);
    
    SET V_COD_PERSONA = LAST_INSERT_ID();

    INSERT INTO CLIENTES (COD_PERSONA, PRIMER_NOMBRE_C, SEGUNDO_NOMBRE_C, PRIMER_APELLIDO_C, SEGUNDO_APELLIDO_C)
    VALUES (V_COD_PERSONA, P_PRIMER_NOMBRE_C, P_SEGUNDO_NOMBRE_C, P_PRIMER_APELLIDO_C, P_SEGUNDO_APELLIDO_C);

    INSERT INTO TELEFONOS (COD_PERSONA, NUMERO_TELEFONO, TIPO_TELEFONO)
    VALUES (V_COD_PERSONA, P_NUMERO_TELEFONO, P_TIPO_TELEFONO);

    INSERT INTO CORREOS (COD_PERSONA, CORREO_ELECTRONICO, TIPO)
    VALUES (V_COD_PERSONA, P_CORREO_ELECTRONICO, P_TIPO_CORREO);

    INSERT INTO DIRECCIONES (COD_PERSONA, CALLE, CIUDAD, PAIS, CODIGO_POSTAL, TIPO)
    VALUES (V_COD_PERSONA, P_CALLE, P_CIUDAD, P_PAIS, P_CODIGO_POSTAL, P_TIPO_DIRECCION);
    
END //
DELIMITER ;
CALL sp_InsertarCliente('Anthony', 'Steven', 'Sanchez', 'Diaz', '1501-2001-00121', '0019-2001-992801', '97621612', 'PERSONAL', 'anthony@email.com', 'PERSONAL', 'Concepcion', 'Tegucigalpa', 'Honduras', '11101', 'DOMICILIO' );
CALL sp_InsertarCliente('Juan', 'Carlos', 'Pérez', 'Gómez', '0102-1980-02909', '0093-1980-992892', '98765432', 'PERSONAL', 'juan.perez@email.com', 'PERSONAL', 'Calle Principal Valle de Angeles', 'Tegucigalpa', 'Honduras', '11101', 'DOMICILIO' );
CALL sp_InsertarCliente('Pedro', 'Jose', 'Gonzalez', 'Lopez', '0102-1970-02009', '0102-1970-992892', '99190132', 'PERSONAL', 'pedro@email.com', 'PERSONAL', 'Calle Principal Valle de Angeles', 'Tegucigalpa', 'Honduras', '11101', 'DOMICILIO' );
CALL sp_InsertarCliente('Liam', 'Fabian', 'Amador', 'Lopez', '0102-1995-02992', '0102-1995-993993', '92517728', 'PERSONAL', 'liam@email.com', 'PERSONAL', 'Calle Principal Valle de Angeles', 'Tegucigalpa', 'Honduras', '11101', 'DOMICILIO' );

-- ACTUALIZAR CLIENTE 
DELIMITER //
CREATE PROCEDURE sp_ActualizarCliente(
    IN P_COD_CLIENTE INT,
    IN P_PRIMER_NOMBRE_C VARCHAR(100), 
    IN P_SEGUNDO_NOMBRE_C VARCHAR(100),
    IN P_PRIMER_APELLIDO_C VARCHAR(100), 
    IN P_SEGUNDO_APELLIDO_C VARCHAR(100),
    IN P_NUMERO_IDENTIDAD VARCHAR(16), 
    IN P_RTN VARCHAR(16),
    IN P_NUMERO_TELEFONO VARCHAR(15), 
    IN P_TIPO_TELEFONO ENUM('PERSONAL', 'LABORAL', 'OTRO'),
    IN P_CORREO_ELECTRONICO VARCHAR(30), 
    IN P_TIPO_CORREO ENUM('PERSONAL', 'LABORAL', 'OTRO'),
    IN P_CALLE VARCHAR(50), 
    IN P_CIUDAD VARCHAR(50), 
    IN P_PAIS VARCHAR(50), 
    IN P_CODIGO_POSTAL VARCHAR(50),
    IN P_TIPO_DIRECCION ENUM('DOMICILIO', 'LABORAL', 'OTRO')
)
BEGIN
    DECLARE V_COD_PERSONA INT;
    DECLARE V_EXISTE_IDENTIDAD INT;

    -- Obtener COD_PERSONA asociado al cliente
    SELECT COD_PERSONA INTO V_COD_PERSONA 
    FROM CLIENTES 
    WHERE COD_CLIENTE = P_COD_CLIENTE;

    -- Verificar si se encontró un COD_PERSONA válido
    IF V_COD_PERSONA IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: Cliente no encontrado.';
    END IF;

    -- Validar si el número de identidad ya existe en otra persona
    SELECT COUNT(*) INTO V_EXISTE_IDENTIDAD 
    FROM PERSONAS 
    WHERE NUMERO_IDENTIDAD = P_NUMERO_IDENTIDAD 
      AND COD_PERSONA != V_COD_PERSONA;

    IF V_EXISTE_IDENTIDAD > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El número de identidad ya existe en otra persona.';
    ELSE
        -- Actualizar tabla PERSONAS
        UPDATE PERSONAS 
        SET PRIMER_NOMBRE = P_PRIMER_NOMBRE_C, 
            SEGUNDO_NOMBRE = P_SEGUNDO_NOMBRE_C, 
            PRIMER_APELLIDO = P_PRIMER_APELLIDO_C, 
            SEGUNDO_APELLIDO = P_SEGUNDO_APELLIDO_C, 
            NUMERO_IDENTIDAD = P_NUMERO_IDENTIDAD, 
            RTN = P_RTN
        WHERE COD_PERSONA = V_COD_PERSONA;

        -- Actualizar tabla CLIENTES
        UPDATE CLIENTES
        SET PRIMER_NOMBRE_C = P_PRIMER_NOMBRE_C,
            SEGUNDO_NOMBRE_C = P_SEGUNDO_NOMBRE_C,
            PRIMER_APELLIDO_C = P_PRIMER_APELLIDO_C,
            SEGUNDO_APELLIDO_C = P_SEGUNDO_APELLIDO_C
        WHERE COD_CLIENTE = P_COD_CLIENTE;

        IF EXISTS (SELECT 1 FROM TELEFONOS WHERE COD_PERSONA = V_COD_PERSONA AND NUMERO_TELEFONO != P_NUMERO_TELEFONO) THEN
            UPDATE TELEFONOS 
            SET NUMERO_TELEFONO = P_NUMERO_TELEFONO, 
                TIPO_TELEFONO = P_TIPO_TELEFONO
            WHERE COD_PERSONA = V_COD_PERSONA;
        END IF;

        IF EXISTS (SELECT 1 FROM CORREOS WHERE COD_PERSONA = V_COD_PERSONA) THEN
            UPDATE CORREOS 
            SET CORREO_ELECTRONICO = P_CORREO_ELECTRONICO, 
                TIPO = P_TIPO_CORREO
            WHERE COD_PERSONA = V_COD_PERSONA;
        ELSE
            INSERT INTO CORREOS (COD_PERSONA, CORREO_ELECTRONICO, TIPO)
            VALUES (V_COD_PERSONA, P_CORREO_ELECTRONICO, P_TIPO_CORREO);
        END IF;

        IF EXISTS (SELECT 1 FROM DIRECCIONES WHERE COD_PERSONA = V_COD_PERSONA) THEN
            UPDATE DIRECCIONES 
            SET CALLE = P_CALLE, 
                CIUDAD = P_CIUDAD, 
                PAIS = P_PAIS, 
                CODIGO_POSTAL = P_CODIGO_POSTAL, 
                TIPO = P_TIPO_DIRECCION
            WHERE COD_PERSONA = V_COD_PERSONA;
        ELSE
            INSERT INTO DIRECCIONES (COD_PERSONA, CALLE, CIUDAD, PAIS, CODIGO_POSTAL, TIPO)
            VALUES (V_COD_PERSONA, P_CALLE, P_CIUDAD, P_PAIS, P_CODIGO_POSTAL, P_TIPO_DIRECCION);
        END IF;
    END IF;
END //
DELIMITER ;
CALL sp_ActualizarCliente(4, 'Liam', 'Fabian', 'Amador', 'Lopez', '0102-1995-02992', '0102-1995-993993', '92517723', 'PERSONAL', 'liamf@email.com', 'PERSONAL', 'Calle Principal Valle de Angeles', 'Tegucigalpa', 'Honduras', '11101', 'DOMICILIO' );
DROP PROCEDURE IF exists sp_ActualizarCliente;
-- ELIMINAR CLIENTE 
DELIMITER //
CREATE PROCEDURE sp_EliminarCliente(
    IN P_COD_CLIENTE INT
)
BEGIN
    DECLARE P_COD_PERSONA INT;
    
    -- Obtener el COD_PERSONA del cliente
    SELECT COD_PERSONA INTO P_COD_PERSONA
    FROM CLIENTES
    WHERE COD_CLIENTE = P_COD_CLIENTE;
    
    -- Eliminar registros relacionados
    DELETE FROM DIRECCIONES WHERE COD_PERSONA = P_COD_PERSONA;
    DELETE FROM CORREOS WHERE COD_PERSONA = P_COD_PERSONA;
    DELETE FROM TELEFONOS WHERE COD_PERSONA = P_COD_PERSONA;

    -- Eliminar el cliente
    DELETE FROM CLIENTES WHERE COD_CLIENTE = P_COD_CLIENTE;
    
    -- Eliminar la persona
    DELETE FROM PERSONAS WHERE COD_PERSONA = P_COD_PERSONA;
END //
DELIMITER ;
CALL sp_EliminarCliente(4);

-- LISTAR CLIENTE 
-- LISTAR CLIENTE 
DELIMITER //
CREATE PROCEDURE sp_ListarClientes(
    IN p_nombre VARCHAR(100),
    IN p_numero_identidad VARCHAR(15),
    IN p_cod_cliente INT
)
BEGIN
    SELECT 
        C.COD_CLIENTE,
        CONCAT(P.PRIMER_NOMBRE, ' ', P.SEGUNDO_NOMBRE, ' ', P.PRIMER_APELLIDO, ' ', P.SEGUNDO_APELLIDO) AS NOMBRE_COMPLETO,
        P.PRIMER_NOMBRE AS PRIMER_NOMBRE_C,
        P.SEGUNDO_NOMBRE AS SEGUNDO_NOMBRE_C,
        P.PRIMER_APELLIDO AS PRIMER_APELLIDO_C,
        P.SEGUNDO_APELLIDO AS SEGUNDO_APELLIDO_C,
        P.NUMERO_IDENTIDAD,
        P.RTN,
        T.NUMERO_TELEFONO,
        T.TIPO_TELEFONO,
        CO.CORREO_ELECTRONICO,
        CO.TIPO AS TIPO_CORREO,
        D.CALLE,
        D.CIUDAD,
        D.PAIS,
        D.CODIGO_POSTAL,
        D.TIPO AS TIPO_DIRECCION
    FROM CLIENTES C
    JOIN PERSONAS P ON C.COD_PERSONA = P.COD_PERSONA
    LEFT JOIN TELEFONOS T ON C.COD_PERSONA = T.COD_PERSONA
    LEFT JOIN CORREOS CO ON C.COD_PERSONA = CO.COD_PERSONA
    LEFT JOIN DIRECCIONES D ON C.COD_PERSONA = D.COD_PERSONA
    WHERE 
        (p_nombre IS NULL OR 
         CONCAT(P.PRIMER_NOMBRE, ' ', P.SEGUNDO_NOMBRE, ' ', P.PRIMER_APELLIDO, ' ', P.SEGUNDO_APELLIDO) LIKE CONCAT('%', p_nombre, '%'))
        AND
        (p_numero_identidad IS NULL OR P.NUMERO_IDENTIDAD LIKE CONCAT('%', p_numero_identidad, '%'))
        AND
        (p_cod_cliente IS NULL OR C.COD_CLIENTE = p_cod_cliente);
END //
DELIMITER ;


DROP PROCEDURE IF exists sp_ListarClientes;
CALL sp_ListarClientes(NULL, NULL);

CALL sp_ListarClientes(NULL, NULL);
CALL sp_ListarClientes('Juan', NULL);
CALL sp_ListarClientes(NULL, '0102-1980-02909');

-- PROCEDIMIENTOS EMPLEADOS 
-- INSERTAR EMPLEADOS 
DELIMITER //
CREATE PROCEDURE sp_InsertarEmpleado(
    IN p_primer_nombre VARCHAR(30),
    IN p_segundo_nombre VARCHAR(30),
    IN p_primer_apellido VARCHAR(30),
    IN p_segundo_apellido VARCHAR(30),
    IN p_numero_identidad VARCHAR(16),
    IN p_rtn VARCHAR(16),
    IN p_puesto ENUM('ADMINISTRADOR', 'VENDEDOR', 'GERENTE', 'JEFE PRODUCCION', 'JEFE DE VENTAS'),
    IN p_numero_telefono VARCHAR(15),
    IN p_tipo_telefono ENUM('PERSONAL', 'LABORAL', 'OTRO'),
    IN p_correo_electronico VARCHAR(30),
    IN p_tipo_correo ENUM('PERSONAL', 'LABORAL', 'OTRO'),
    IN p_calle VARCHAR(50),
    IN p_ciudad VARCHAR(50),
    IN p_pais VARCHAR(50),
    IN p_codigo_postal VARCHAR(50),
    IN p_tipo_direccion ENUM('DOMICILIO', 'LABORAL', 'OTRO')
)
BEGIN
    DECLARE v_cod_persona INT;
    
    INSERT INTO PERSONAS (PRIMER_NOMBRE, SEGUNDO_NOMBRE, PRIMER_APELLIDO, SEGUNDO_APELLIDO, NUMERO_IDENTIDAD, RTN)
    VALUES (p_primer_nombre, p_segundo_nombre, p_primer_apellido, p_segundo_apellido, p_numero_identidad, p_rtn);
    
    SET v_cod_persona = LAST_INSERT_ID();
    
    INSERT INTO EMPLEADOS (COD_PERSONA, PRIMER_NOMBRE_E, SEGUNDO_NOMBRE_E, PRIMER_APELLIDO_E, SEGUNDO_APELLIDO_E, PUESTO)
    VALUES (v_cod_persona, p_primer_nombre, p_segundo_nombre, p_primer_apellido, p_segundo_apellido, p_puesto);
    
    INSERT INTO TELEFONOS (COD_PERSONA, NUMERO_TELEFONO, TIPO_TELEFONO)
    VALUES (v_cod_persona, p_numero_telefono, p_tipo_telefono);
    
    INSERT INTO CORREOS (COD_PERSONA, CORREO_ELECTRONICO, TIPO)
    VALUES (v_cod_persona, p_correo_electronico, p_tipo_correo);
    
    INSERT INTO DIRECCIONES (COD_PERSONA, CALLE, CIUDAD, PAIS, CODIGO_POSTAL, TIPO)
    VALUES (v_cod_persona, p_calle, p_ciudad, p_pais, p_codigo_postal, p_tipo_direccion);
END //
DELIMITER ;
CALL sp_InsertarEmpleado('Osman', 'Leonel', 'Zuniga', 'Juanez', '0801-1970-883999', '1001-1970-928733', 'GERENTE', '90299112','PERSONAL', 'osman@example.com', 'LABORAL', 'Santa Lucia', 'Tegucigalpa', 'Honduras', '11101', 'DOMICILIO');
CALL sp_InsertarEmpleado('Karla', 'Patricia', 'Argueta', 'Valladares', '0801-1972-89736', '1023-1973-255257', 'ADMINISTRADOR', '31902376','PERSONAL', 'as-diaz22@hotmail.com', 'LABORAL', 'Santa Lucia', 'Tegucigalpa', 'Honduras', '11101', 'DOMICILIO');
CALL sp_InsertarEmpleado('Daniela', 'Patricia', 'Zuniga', 'Argueta', '0801-1995-28916', '1024-1995-288327', 'ADMINISTRADOR', '99292343','PERSONAL', 'dani@example.com', 'LABORAL', 'Santa Lucia', 'Tegucigalpa', 'Honduras', '11101', 'DOMICILIO');
CALL sp_InsertarEmpleado('Rosa', 'Esteici', 'Argueta', 'Valladares', '0801-1978-28098', '1024-1978-200800', 'VENDEDOR', '99089673','PERSONAL', 'rosa@example.com', 'LABORAL', 'Santa Lucia', 'Tegucigalpa', 'Honduras', '11101', 'DOMICILIO');

DROP PROCEDURE IF EXISTS sp_ListarEmpleados
-- procedimiento de Actualizar Empleado 
DELIMITER //
CREATE PROCEDURE sp_ActualizarEmpleado(
    IN p_cod_empleado INT,
    IN p_primer_nombre VARCHAR(30),
    IN p_segundo_nombre VARCHAR(30),
    IN p_primer_apellido VARCHAR(30),
    IN p_segundo_apellido VARCHAR(30),
    IN p_numero_identidad VARCHAR(16),
    IN p_rtn VARCHAR(16),
    IN p_puesto ENUM('ADMINISTRADOR', 'VENDEDOR', 'GERENTE', 'JEFE PRODUCCION', 'JEFE DE VENTAS'),
    IN p_numero_telefono VARCHAR(15),
    IN p_tipo_telefono ENUM('PERSONAL', 'LABORAL', 'OTRO'),
    IN p_correo_electronico VARCHAR(30),
    IN p_tipo_correo ENUM('PERSONAL', 'LABORAL', 'OTRO'),
    IN p_calle VARCHAR(50),
    IN p_ciudad VARCHAR(50),
    IN p_pais VARCHAR(50),
    IN p_codigo_postal VARCHAR(50),
    IN p_tipo_direccion ENUM('DOMICILIO', 'LABORAL', 'OTRO')
)
BEGIN
    DECLARE v_cod_persona INT;

    SELECT COD_PERSONA INTO v_cod_persona
    FROM EMPLEADOS
    WHERE COD_EMPLEADO = p_cod_empleado;

    IF v_cod_persona IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'El empleado no existe.';
    ELSE
        IF EXISTS (SELECT 1 FROM PERSONAS WHERE NUMERO_IDENTIDAD = p_numero_identidad AND COD_PERSONA != v_cod_persona) THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'El número de identidad ya existe para otra persona.';
        ELSE
            UPDATE PERSONAS
            SET PRIMER_NOMBRE = p_primer_nombre,
                SEGUNDO_NOMBRE = p_segundo_nombre,
                PRIMER_APELLIDO = p_primer_apellido,
                SEGUNDO_APELLIDO = p_segundo_apellido,
                NUMERO_IDENTIDAD = p_numero_identidad,
                RTN = p_rtn
            WHERE COD_PERSONA = v_cod_persona;
            UPDATE EMPLEADOS
            SET PRIMER_NOMBRE_E = p_primer_nombre,
                SEGUNDO_NOMBRE_E = p_segundo_nombre,
                PRIMER_APELLIDO_E = p_primer_apellido,
                SEGUNDO_APELLIDO_E = p_segundo_apellido,
                PUESTO = p_puesto
            WHERE COD_EMPLEADO = p_cod_empleado;
            
        IF EXISTS (SELECT 1 FROM TELEFONOS WHERE COD_PERSONA = v_cod_persona AND NUMERO_TELEFONO != p_numero_telefono) THEN
            UPDATE TELEFONOS 
            SET NUMERO_TELEFONO = p_numero_telefono, 
                TIPO_TELEFONO = p_tipo_telefono
            WHERE COD_PERSONA = v_cod_persona;
        END IF;

        IF EXISTS (SELECT 1 FROM CORREOS WHERE COD_PERSONA = v_cod_persona) THEN
            UPDATE CORREOS 
            SET CORREO_ELECTRONICO = p_correo_electronico, 
                TIPO = p_tipo_correo
            WHERE COD_PERSONA = v_cod_persona;
        ELSE
            INSERT INTO CORREOS (COD_PERSONA, CORREO_ELECTRONICO, TIPO)
            VALUES (v_cod_persona, p_correo_electronico, p_tipo_correo);
        END IF;

        IF EXISTS (SELECT 1 FROM DIRECCIONES WHERE COD_PERSONA = v_cod_persona) THEN
            UPDATE DIRECCIONES 
            SET CALLE = p_calle, 
                CIUDAD = p_ciudad, 
                PAIS = p_pais, 
                CODIGO_POSTAL = p_codigo_postal, 
                TIPO = p_tipo_direccion
            WHERE COD_PERSONA = v_cod_persona;
        ELSE
            INSERT INTO DIRECCIONES (COD_PERSONA, CALLE, CIUDAD, PAIS, CODIGO_POSTAL, TIPO)
            VALUES (v_cod_persona, p_calle, p_ciudad, p_pais, p_codigo_postal, p_tipo_direccion);
        END IF;
  END IF;
END IF;
END //
DELIMITER ;




DROP PROCEDURE IF EXISTS sp_ActualizarEmpleado;
CALL sp_ActualizarEmpleado(3, 'Daniela', 'Patricia', 'Zuniga', 'Argueta', '0801-1995-28916', '1024-1995-288327', 'ADMINISTRADOR', '31099202','PERSONAL', 'dani@example.com', 'LABORAL', 'Santa Lucia', 'Tegucigalpa', 'Honduras', '11101', 'DOMICILIO');
CALL sp_ActualizarEmpleado(4, 'Rosa', 'Esteici', 'Argueta', 'Pagoada', '0801-1978-28098', '1024-1978-200800', 'VENDEDOR', '99089680','PERSONAL', 'rosae@example.com', 'LABORAL', 'Santa Lucia', 'Tegucigalpa', 'Honduras', '11101', 'DOMICILIO');
CALL sp_ActualizarEmpleado(1,'Osman', 'Leonel', 'Zuniga', 'Juanez', '0801-1970-883999', '1001-1970-928733', 'GERENTE', '90299112','PERSONAL', 'anahiargueta10@gmail.com', 'LABORAL', 'Santa Lucia', 'Tegucigalpa', 'Honduras', '11101', 'DOMICILIO');
CALL sp_ActualizarEmpleado(1,'Osman', 'Leonel', 'Zuniga', 'Juanezz', '0801-1970-883999', '1001-1970-928733', 'GERENTE', '90299112','PERSONAL', 'anahiargueta10@gmail.com', 'LABORAL', 'Santa Lucia', 'Tegucigalpa', 'Honduras', '11101', 'DOMICILIO');

-- ELIMINAR EMPLEADOS
DELIMITER //
CREATE PROCEDURE sp_EliminarEmpleado(
    IN p_cod_empleado INT
)
BEGIN
    DECLARE v_cod_persona INT;
    
    SELECT COD_PERSONA INTO v_cod_persona
    FROM EMPLEADOS
    WHERE COD_EMPLEADO = p_cod_empleado;
    
    IF v_cod_persona IS NOT NULL THEN
        DELETE FROM DIRECCIONES
        WHERE COD_PERSONA = v_cod_persona;
        
        DELETE FROM CORREOS
        WHERE COD_PERSONA = v_cod_persona;
        
        DELETE FROM TELEFONOS
        WHERE COD_PERSONA = v_cod_persona;
        
        DELETE FROM EMPLEADOS
        WHERE COD_EMPLEADO = p_cod_empleado; 
        
        DELETE FROM PERSONAS
        WHERE COD_PERSONA = v_cod_persona;
    ELSE
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Empleado no encontrado';
    END IF;
END //
DELIMITER ;

CALL sp_EliminarEmpleado(8);
select*from materiales;
SELECT*FROM usuarios
-- LISTAR EMPLEADOS 
-- LISTAR EMPLEADO
 DELIMITER //

DELIMITER //

CREATE PROCEDURE sp_ListarEmpleados(
    IN p_cod_empleado INT,
    IN p_nombre VARCHAR(100),
    IN p_numero_identidad VARCHAR(15),  
    IN p_puesto VARCHAR(50)
)
BEGIN
    -- Si p_cod_empleado no es NULL, buscar por COD_EMPLEADO
    IF p_cod_empleado IS NOT NULL THEN
        SELECT        
            EMPLEADOS.COD_EMPLEADO,
            PRIMER_NOMBRE,  -- Nuevo: devolver campo separado
            SEGUNDO_NOMBRE, -- Nuevo: devolver campo separado
            PRIMER_APELLIDO, -- Nuevo: devolver campo separado
            SEGUNDO_APELLIDO, -- Nuevo: devolver campo separado
            CONCAT(PRIMER_NOMBRE, ' ', SEGUNDO_NOMBRE, ' ', PRIMER_APELLIDO, ' ', SEGUNDO_APELLIDO) AS NOMBRE_COMPLETO,        
            NUMERO_IDENTIDAD,
            RTN,        
            PUESTO,
            TELEFONOS.NUMERO_TELEFONO,        
            TELEFONOS.TIPO_TELEFONO,
            CORREOS.CORREO_ELECTRONICO,        
            CORREOS.TIPO AS TIPO_CORREO,
            DIRECCIONES.CALLE,        
            DIRECCIONES.CIUDAD,
            DIRECCIONES.PAIS,        
            DIRECCIONES.CODIGO_POSTAL,
            DIRECCIONES.TIPO AS TIPO_DIRECCION   
        FROM PERSONAS
        JOIN EMPLEADOS ON PERSONAS.COD_PERSONA = EMPLEADOS.COD_PERSONA
        LEFT JOIN TELEFONOS ON PERSONAS.COD_PERSONA = TELEFONOS.COD_PERSONA
        LEFT JOIN CORREOS ON PERSONAS.COD_PERSONA = CORREOS.COD_PERSONA
        LEFT JOIN DIRECCIONES ON PERSONAS.COD_PERSONA = DIRECCIONES.COD_PERSONA
        WHERE EMPLEADOS.COD_EMPLEADO = p_cod_empleado;
    ELSE
        -- Si p_cod_empleado es NULL, aplicar los filtros originales
        SELECT        
            EMPLEADOS.COD_EMPLEADO,
            PRIMER_NOMBRE,  -- Nuevo: devolver campo separado
            SEGUNDO_NOMBRE, -- Nuevo: devolver campo separado
            PRIMER_APELLIDO, -- Nuevo: devolver campo separado
            SEGUNDO_APELLIDO, -- Nuevo: devolver campo separado
            CONCAT(PRIMER_NOMBRE, ' ', SEGUNDO_NOMBRE, ' ', PRIMER_APELLIDO, ' ', SEGUNDO_APELLIDO) AS NOMBRE_COMPLETO,        
            NUMERO_IDENTIDAD,
            RTN,        
            PUESTO,
            TELEFONOS.NUMERO_TELEFONO,        
            TELEFONOS.TIPO_TELEFONO,
            CORREOS.CORREO_ELECTRONICO,        
            CORREOS.TIPO AS TIPO_CORREO,
            DIRECCIONES.CALLE,        
            DIRECCIONES.CIUDAD,
            DIRECCIONES.PAIS,        
            DIRECCIONES.CODIGO_POSTAL,
            DIRECCIONES.TIPO AS TIPO_DIRECCION   
        FROM PERSONAS
        JOIN EMPLEADOS ON PERSONAS.COD_PERSONA = EMPLEADOS.COD_PERSONA
        LEFT JOIN TELEFONOS ON PERSONAS.COD_PERSONA = TELEFONOS.COD_PERSONA
        LEFT JOIN CORREOS ON PERSONAS.COD_PERSONA = CORREOS.COD_PERSONA
        LEFT JOIN DIRECCIONES ON PERSONAS.COD_PERSONA = DIRECCIONES.COD_PERSONA
        WHERE (p_nombre IS NULL OR 
               CONCAT(PRIMER_NOMBRE, ' ', SEGUNDO_NOMBRE, ' ', PRIMER_APELLIDO, ' ', SEGUNDO_APELLIDO) LIKE CONCAT('%', p_nombre, '%'))
          AND (p_numero_identidad IS NULL OR NUMERO_IDENTIDAD LIKE CONCAT('%', p_numero_identidad, '%'))
          AND (p_puesto IS NULL OR PUESTO LIKE CONCAT('%', p_puesto, '%'));
    END IF;
END //
DELIMITER ;


DELIMITER ;

DROP PROCEDURE IF EXISTS sp_ListarEmpleados;

CALL sp_ListarEmpleados(NULL, NULL,NULL,NULL);
DROP PROCEDURE IF EXISTS sp_ListarEmpleados
-- PROCEDIMIENTOS PROVEEDORES
-- INSERTAR PROVEEDORES 
DELIMITER //
CREATE PROCEDURE sp_InsertarProveedores (
    IN P_NOMBRE_PROVEEDOR VARCHAR(100),
    IN P_NOMBRE_CONTACTO VARCHAR(100),
    IN P_APELLIDO_CONTACTO VARCHAR(100),
    IN P_NUMERO_IDENTIDAD VARCHAR(16),
    IN P_RTN VARCHAR(16),
    IN P_CALLE VARCHAR(50),
    IN P_CIUDAD VARCHAR(50),
    IN P_PAIS VARCHAR(50),
    IN P_CODIGO_POSTAL VARCHAR(50),
    IN P_TELEFONO VARCHAR(15),
    IN P_CORREO VARCHAR(100)
)
BEGIN
    DECLARE V_PERSONA_ID INT;
    
    INSERT INTO PERSONAS (PRIMER_NOMBRE, PRIMER_APELLIDO, NUMERO_IDENTIDAD, RTN)
    VALUES (P_NOMBRE_CONTACTO, P_APELLIDO_CONTACTO, P_NUMERO_IDENTIDAD, P_RTN);
    
    SET V_PERSONA_ID = LAST_INSERT_ID();
    
    INSERT INTO PROVEEDORES (COD_PERSONA, NOMBRE_EMPRESA, NOMBRE_CONTACTO, APELLIDO_CONTACTO)
    VALUES (V_PERSONA_ID, P_NOMBRE_PROVEEDOR, P_NOMBRE_CONTACTO, P_APELLIDO_CONTACTO);
    
    INSERT INTO DIRECCIONES (COD_PERSONA, CALLE, CIUDAD, PAIS, CODIGO_POSTAL, TIPO)
    VALUES (V_PERSONA_ID, P_CALLE, P_CIUDAD, P_PAIS, P_CODIGO_POSTAL, 'LABORAL');
    
    INSERT INTO TELEFONOS (COD_PERSONA, NUMERO_TELEFONO, TIPO_TELEFONO)
    VALUES (V_PERSONA_ID, P_TELEFONO, 'LABORAL');
    
    INSERT INTO CORREOS (COD_PERSONA, CORREO_ELECTRONICO, TIPO)
    VALUES (V_PERSONA_ID, P_CORREO, 'LABORAL');
    
END //
DELIMITER ;
CALL sp_InsertarProveedores('ABC', 'Cristhian', 'Martinez', '0801-2000-00722', '1001-2002-901911', 'Divanna', 'Tegucigalpa', 'Honduras', '11101', '97654321', 'cris@abc.com');
CALL sp_InsertarProveedores('DEF', 'Javier', 'Hernandez', '0801-2003-02812', '0900-2003-910929', 'Col. Prados', 'Tegucigalpa', 'Honduras', '11102', '93424321', 'javier@abc.com');


-- ACTUALIZAR PROVEEDOR
DELIMITER //
CREATE PROCEDURE sp_ActualizarProveedor(
    IN P_COD_PROVEEDOR INT,
    IN P_NOMBRE_PROVEEDOR VARCHAR(100),
    IN P_NOMBRE_CONTACTO VARCHAR(100),
    IN P_APELLIDO_CONTACTO VARCHAR(100),
    IN P_NUMERO_IDENTIDAD VARCHAR(16),
    IN P_RTN VARCHAR(16),
    IN P_CALLE VARCHAR(50),
    IN P_CIUDAD VARCHAR(50),
    IN P_PAIS VARCHAR(50),
    IN P_CODIGO_POSTAL VARCHAR(50),
    IN P_TELEFONO VARCHAR(15),
    IN P_CORREO VARCHAR(100)
)
BEGIN
    DECLARE V_COD_PERSONA INT;

    SELECT COD_PERSONA 
    INTO V_COD_PERSONA FROM PROVEEDORES WHERE COD_PROVEEDORES = P_COD_PROVEEDOR;

    UPDATE PERSONAS
    SET PRIMER_NOMBRE = P_NOMBRE_CONTACTO,
        PRIMER_APELLIDO = P_APELLIDO_CONTACTO,
        NUMERO_IDENTIDAD = P_NUMERO_IDENTIDAD,
        RTN = P_RTN
    WHERE COD_PERSONA = V_COD_PERSONA;

    UPDATE PROVEEDORES
    SET NOMBRE_EMPRESA = P_NOMBRE_PROVEEDOR,
        NOMBRE_CONTACTO = P_NOMBRE_CONTACTO,
        APELLIDO_CONTACTO = P_APELLIDO_CONTACTO
    WHERE COD_PROVEEDORES = P_COD_PROVEEDOR;

    UPDATE DIRECCIONES
    SET CALLE = P_CALLE,
        CIUDAD = P_CIUDAD,
        PAIS = P_PAIS,
        CODIGO_POSTAL = P_CODIGO_POSTAL
    WHERE COD_PERSONA = V_COD_PERSONA AND TIPO = 'LABORAL';

    UPDATE TELEFONOS
    SET NUMERO_TELEFONO = P_TELEFONO
    WHERE COD_PERSONA = V_COD_PERSONA AND TIPO_TELEFONO = 'LABORAL';

    UPDATE CORREOS
    SET CORREO_ELECTRONICO = P_CORREO
    WHERE COD_PERSONA = V_COD_PERSONA AND TIPO = 'LABORAL';

END //
DELIMITER ;
CALL sp_ActualizarProveedor(2, 'DEF', 'Javier', 'Hernandez', '0801-2001-02812', '0900-2003-910929', 'Col. Prados', 'Tegucigalpa', 'Honduras', '11102', '93424321', 'javier@abc.com');
DROP PROCEDURE IF EXISTS sp_ActuaizarProveedor
-- ELIMINAR PROVEEDOR 
DELIMITER //
CREATE PROCEDURE sp_EliminarProveedor(
    IN P_COD_PROVEEDOR INT
)
BEGIN
    DECLARE V_COD_PERSONA INT;

    IF (SELECT COUNT(*) FROM PROVEEDORES WHERE COD_PROVEEDORES = P_COD_PROVEEDOR) = 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El proveedor no existe.';
    ELSE
        SELECT COD_PERSONA INTO V_COD_PERSONA FROM PROVEEDORES WHERE COD_PROVEEDORES = P_COD_PROVEEDOR;

        DELETE FROM DIRECCIONES WHERE COD_PERSONA = V_COD_PERSONA;
        DELETE FROM TELEFONOS WHERE COD_PERSONA = V_COD_PERSONA;
        DELETE FROM CORREOS WHERE COD_PERSONA = V_COD_PERSONA;
        DELETE FROM PROVEEDORES WHERE COD_PROVEEDORES = P_COD_PROVEEDOR;
        DELETE FROM PERSONAS WHERE COD_PERSONA = V_COD_PERSONA;
    END IF;
    
END //
DELIMITER ;
CALL sp_EliminarProveedor(2);

-- LISTAR PROVEEDORES 
DELIMITER //
CREATE PROCEDURE sp_ListarProveedores(    
    IN p_cod_proveedor INT,
    IN p_nombre_empresa VARCHAR(100),
    IN p_nombre_contacto VARCHAR(100))
BEGIN    
    SELECT 
        P.COD_PROVEEDORES,       
        P.NOMBRE_EMPRESA,
        CONCAT(
            IFNULL(PE.PRIMER_NOMBRE, ''), ' ',
            IFNULL(PE.SEGUNDO_NOMBRE, '')
        ) AS NOMBRE_CONTACTO,  -- Solo nombres
        CONCAT(
            IFNULL(PE.PRIMER_APELLIDO, ''), ' ',
            IFNULL(PE.SEGUNDO_APELLIDO, '')
        ) AS APELLIDO_CONTACTO, -- Solo apellidos
        PE.NUMERO_IDENTIDAD,      
        PE.RTN,
        D.CALLE,       
        D.CIUDAD,
        D.PAIS,        
        D.CODIGO_POSTAL,
        T.NUMERO_TELEFONO,        
        C.CORREO_ELECTRONICO
    FROM PROVEEDORES P   
    INNER JOIN PERSONAS PE ON P.COD_PERSONA = PE.COD_PERSONA
    LEFT JOIN DIRECCIONES D ON PE.COD_PERSONA = D.COD_PERSONA AND D.TIPO = 'LABORAL'   
    LEFT JOIN TELEFONOS T ON PE.COD_PERSONA = T.COD_PERSONA AND T.TIPO_TELEFONO = 'LABORAL'
    LEFT JOIN CORREOS C ON PE.COD_PERSONA = C.COD_PERSONA AND C.TIPO = 'LABORAL'   
    WHERE 
        (p_cod_proveedor IS NULL OR P.COD_PROVEEDORES = p_cod_proveedor) AND
        (p_nombre_empresa IS NULL OR P.NOMBRE_EMPRESA LIKE CONCAT('%', p_nombre_empresa, '%')) AND
        (p_nombre_contacto IS NULL OR         
        CONCAT(
            IFNULL(PE.PRIMER_NOMBRE, ''), ' ',
            IFNULL(PE.SEGUNDO_NOMBRE, '')
        ) LIKE CONCAT('%', p_nombre_contacto, '%'));
END //
DELIMITER ;

DROP PROCEDURE IF EXISTS sp_ListarProveedores;
CALL sp_ListarProveedores(NULL, NULL);
CALL sp_ListarProveedores('ABC', NULL);
CALL sp_ListarProveedores(NULL, 'Cristhian');

-- PROCEDIMIENTOS ROLES 
-- INSERTAR ROL
DELIMITER //
CREATE PROCEDURE sp_InsertarRol(
    IN P_NOMBRE_ROL VARCHAR(255),
    IN P_DESCRIPCION_ROL VARCHAR(255),
    IN P_USUARIO_CREA VARCHAR(255)
)
BEGIN
    INSERT INTO ROLES (NOMBRE_ROL, DESCRIPCION_ROL, USUARIO_CREA) 
    VALUES (P_NOMBRE_ROL, P_DESCRIPCION_ROL, P_USUARIO_CREA);
END//
DELIMITER ;
CALL sp_InsertarRol('GERENTE', 'Acceso completo al sistema', 'admin');
CALL sp_InsertarRol('ADMINISTRADOR', 'Acceso completo al sistema', 'admin');
CALL sp_InsertarRol('VENDED0R', 'Acceso limitado al sistema', 'admin');
CALL sp_InsertarRol('JEFE DE VENTAS', 'Acceso limitado al sistema', 'admin');
CALL sp_InsertarRol('JEFE DE PRODUCCION', 'Acceso limitado al sistema', 'admin');

-- ACTUALIZAR  ROL
DELIMITER //
CREATE PROCEDURE sp_ActualizarRol(
    IN P_COD_ROL BIGINT,
    IN P_NOMBRE_ROL VARCHAR(255),
    IN P_DESCRIPCION_ROL VARCHAR(255),
    IN P_ESTADO_ROL ENUM('1', '0'),
    IN P_USUARIO_MODIFICA VARCHAR(255)
)
BEGIN
    UPDATE ROLES 
    SET NOMBRE_ROL = P_NOMBRE_ROL,
        DESCRIPCION_ROL = P_DESCRIPCION_ROL,
        ESTADO_ROL = P_ESTADO_ROL,
        USUARIO_CREA = P_USUARIO_MODIFICA,
        FECHA_CREA = CURRENT_TIMESTAMP
    WHERE COD_ROL = P_COD_ROL;
END//
DELIMITER ;
CALL sp_ActualizarRol(1, 'GERENTE', 'Gestiona el sistema', '1', 'admin');

-- ELIMINAR ROL
DELIMITER //
CREATE PROCEDURE sp_EliminarRol(
    IN P_COD_ROL BIGINT
)
BEGIN
    DELETE FROM ROLES WHERE COD_ROL = P_COD_ROL;
END//
DELIMITER ;
CALL sp_EliminarRol(5);

-- LISTAR ROL
-- LISTAR ROLES
DELIMITER //
CREATE PROCEDURE sp_ListarRoles(
    IN p_nombre_rol VARCHAR(50)
)
BEGIN
    SELECT *
    FROM ROLES
    WHERE 
        p_nombre_rol IS NULL
        OR NOMBRE_ROL LIKE CONCAT('%', p_nombre_rol, '%');
END //
DELIMITER ;
CALL sp_ListarRoles(NULL);
CALL sp_ListarRoles('Admin');
CALL sp_ListarRoles();

-- PROCEDIMIENTOS OBJETOS 
-- INSERTAR OBJETO 
DELIMITER //
CREATE PROCEDURE sp_InsertarObjeto(
    IN P_NOMBRE_OBJETO VARCHAR(255),
    IN P_TIPO_OBJETO VARCHAR(255),
    IN P_DESCRIPCION_OBJETO VARCHAR(255),
    IN P_USUARIO_CREA VARCHAR(255)
)
BEGIN
    INSERT INTO OBJETOS (NOMBRE_OBJETO, TIPO_OBJETO, DESCRIPCION_OBJETO, USUARIO_CREA) 
    VALUES (P_NOMBRE_OBJETO, P_TIPO_OBJETO, P_DESCRIPCION_OBJETO, P_USUARIO_CREA);
END//
DELIMITER ;
CALL sp_InsertarObjeto('Modulo de Usuarios', 'Modulo', 'Gestiona usuarios del sistema', 'admin');
CALL sp_InsertarObjeto('Modulo de Ventas', 'Modulo', 'Gestiona las ventas en el sistema', 'admin');
CALL sp_InsertarObjeto('Modulo de Compras', 'Modulo', 'Gestiona las compras en el sistema', 'admin');

-- ACTUALIZAR OBJETO 
DELIMITER //
CREATE PROCEDURE sp_ActualizarObjeto(
    IN P_COD_OBJETO BIGINT,
    IN P_NOMBRE_OBJETO VARCHAR(255),
    IN P_TIPO_OBJETO VARCHAR(255),
    IN P_DESCRIPCION_OBJETO VARCHAR(255),
    IN P_ESTADO_OBJETO ENUM('1', '0'),
    IN P_USUARIO_MODIFICA VARCHAR(255)
)
BEGIN
    UPDATE OBJETOS 
    SET NOMBRE_OBJETO = P_NOMBRE_OBJETO,
        TIPO_OBJETO = P_TIPO_OBJETO,
        DESCRIPCION_OBJETO = P_DESCRIPCION_OBJETO,
        ESTADO_OBJETO = P_ESTADO_OBJETO,
        USUARIO_CREA = P_USUARIO_MODIFICA,
        FECHA_CREA = CURRENT_TIMESTAMP
    WHERE COD_OBJETO = P_COD_OBJETO;
END//
DELIMITER ;
CALL sp_ActualizarObjeto(3, 'Modulo de Compras', 'Modulo', 'Gestiona las compras en el sistema', 1 , 'admin');

-- ELIMINAR OBJETOS
DELIMITER //
CREATE PROCEDURE sp_EliminarObjeto(
    IN P_COD_OBJETO BIGINT
)
BEGIN
    DELETE FROM OBJETOS WHERE COD_OBJETO = P_COD_OBJETO;
END//
DELIMITER ;
CALL sp_EliminarObjeto(3);

-- LISTAR OBJETOS
DELIMITER //
CREATE PROCEDURE sp_ListarObjetos()
BEGIN
    SELECT * FROM OBJETOS;
END//
DELIMITER ;
CALL sp_ListarObjetos();

-- PROCEDIMIENTOS ACCESOS 
DELIMITER //
CREATE PROCEDURE sp_InsertarOActualizarAcceso(
    IN P_COD_ROL BIGINT,
    IN P_COD_OBJETO BIGINT,
    IN P_ESTADO_MODULO ENUM('1', '0'),
    IN P_ESTADO_SELECCION ENUM('1', '0'),
    IN P_ESTADO_INSERCION ENUM('1', '0'),
    IN P_ESTADO_ACTUALIZACION ENUM('1', '0'),
    IN P_ESTADO_ELIMINACION ENUM('1', '0'),
    IN P_USUARIO_CREA VARCHAR(255)
)
BEGIN
    INSERT INTO ACCESOS (
        COD_ROL, COD_OBJETO, ESTADO_MODULO, ESTADO_SELECCION, 
        ESTADO_INSERCION, ESTADO_ACTUALIZACION, ESTADO_ELIMINACION, 
        USUARIO_CREA, FECHA_CREA
    ) VALUES (
        P_COD_ROL, P_COD_OBJETO, P_ESTADO_MODULO, P_ESTADO_SELECCION, 
        P_ESTADO_INSERCION, P_ESTADO_ACTUALIZACION, P_ESTADO_ELIMINACION, 
        P_USUARIO_CREA, CURRENT_TIMESTAMP
    )
    ON DUPLICATE KEY UPDATE
        ESTADO_MODULO = P_ESTADO_MODULO,
        ESTADO_SELECCION = P_ESTADO_SELECCION,
        ESTADO_INSERCION = P_ESTADO_INSERCION,
        ESTADO_ACTUALIZACION = P_ESTADO_ACTUALIZACION,
        ESTADO_ELIMINACION = P_ESTADO_ELIMINACION,
        USUARIO_CREA = P_USUARIO_CREA,
        FECHA_CREA = CURRENT_TIMESTAMP;
END//
DELIMITER ;
CALL sp_ActualizarAcceso(1, 1, 1, 1, 1, 1 );

-- ELIMINAR ACCESO 
DELIMITER //
CREATE PROCEDURE sp_EliminarAcceso(
    IN P_COD_ACCESO BIGINT
)
BEGIN
    DELETE FROM ACCESOS WHERE COD_ACCESO = P_COD_ACCESO;
END//
DELIMITER ;
CALL sp_EliminarAcceso(1);

-- LISTAR ACCESOS
DELIMITER // 
CREATE PROCEDURE sp_ListarAccesos()
BEGIN
    SELECT * FROM ACCESOS;
END//
DELIMITER ;
CALL sp_ListarAccesos();

-- PROCEDIMIENTOS USUARIOS 
-- INSERTAR USUARIO
DELIMITER //
CREATE PROCEDURE sp_InsertarUsuario(
    IN p_cod_empleado INT,
    IN p_cod_rol BIGINT,
    IN p_nombre_usuario VARCHAR(255),
    IN p_contrasena VARCHAR(2000),
    IN p_usuario_crea VARCHAR(255)
)
BEGIN
    INSERT INTO USUARIOS (
		COD_EMPLEADO, COD_ROL, NOMBRE_USUARIO, CONTRASENA, 
        ESTADO_USUARIO, PERMISO_INSERCION, USUARIO_CREA, FECHA_CREA
    ) VALUES (
         p_cod_empleado, p_cod_rol, p_nombre_usuario, p_contrasena, '1', '1', p_usuario_crea, NOW()
    );
END //
DELIMITER ;
CALL sp_InsertarUsuario(1, 1, 'Ozuniga', 'osman.1970',  'admin');
CALL sp_InsertarUsuario(2, 2, 'Kargueta', 'karg.1973',  'admin');
CALL sp_InsertarUsuario(3, 3, 'Dargueta', 'dar.1995',  'admin');

-- ACTUALIZAR USUARIOS 
DELIMITER //
CREATE PROCEDURE sp_ActualizarUsuario(
    IN p_cod_usuario BIGINT,
    IN p_cod_empleado INT,
    IN p_cod_rol BIGINT,
    IN p_nombre_usuario VARCHAR(255),
    IN p_contrasena VARCHAR(2000),
    IN p_estado_usuario ENUM('1', '0'),
    IN p_permiso_insercion ENUM('1', '0'),
    IN p_usuario_crea VARCHAR(255)
)
BEGIN
    UPDATE USUARIOS
    SET 
        COD_EMPLEADO = p_cod_empleado, 
        COD_ROL = p_cod_rol, 
        NOMBRE_USUARIO = p_nombre_usuario, 
        CONTRASENA = p_contrasena, 
        ESTADO_USUARIO = p_estado_usuario, 
        PERMISO_INSERCION = p_permiso_insercion, 
        USUARIO_CREA = p_usuario_crea, 
        FECHA_CREA = NOW()
    WHERE COD_USUARIO = p_cod_usuario;
END //
DELIMITER ;
CALL sp_ActualizarUsuario(3, 3, 4, 'Dargueta', 'Dar1995', '1', '1', 'admin');

-- DESACTIVAR USUARIOS 
DELIMITER //
CREATE PROCEDURE sp_DesactivarUsuario(
    IN p_cod_usuario BIGINT
)
BEGIN
    UPDATE USUARIOS 
    SET ESTADO_USUARIO = '0' 
    WHERE COD_USUARIO = p_cod_usuario;
END //
DELIMITER ;
CALL sp_DesactivarUsuario(3);

-- ELIMINAR USUARIOS 
DELIMITER //
CREATE PROCEDURE sp_EliminarUsuario(
    IN p_cod_usuario BIGINT
)
BEGIN
    DELETE FROM USUARIOS WHERE COD_USUARIO = p_cod_usuario;
END //
DELIMITER ;
CALL sp_EliminarUsuario(6);
SELECT*FROM USUARIOS

-- LISTAR USUARIOS 


DELIMITER //
CREATE PROCEDURE sp_ListarUsuarios(
    IN p_cod_usuario VARCHAR(10),
    IN p_cod_empleado VARCHAR(10),
    IN p_cod_rol VARCHAR(10)
)
BEGIN
    SELECT 
        u.COD_USUARIO,
        CONCAT(
            COALESCE(e.PRIMER_NOMBRE_E, ''), ' ',
            COALESCE(e.SEGUNDO_NOMBRE_E, ''), ' ',
            COALESCE(e.PRIMER_APELLIDO_E, ''), ' ',
            COALESCE(e.SEGUNDO_APELLIDO_E, '')
        ) AS NOMBRE_EMPLEADO,
        r.NOMBRE_ROL,
        u.NOMBRE_USUARIO,
        c.CORREO_ELECTRONICO,
        c.TIPO AS TIPO_CORREO,  -- Renombramos TIPO a TIPO_CORREO para consistencia
        u.ESTADO_USUARIO
    FROM USUARIOS u
    JOIN EMPLEADOS e ON u.COD_EMPLEADO = e.COD_EMPLEADO
    JOIN PERSONAS p ON e.COD_PERSONA = p.COD_PERSONA
    LEFT JOIN CORREOS c ON p.COD_PERSONA = c.COD_PERSONA  -- LEFT JOIN por si no hay correo
    JOIN ROLES r ON u.COD_ROL = r.COD_ROL
    WHERE (p_cod_usuario IS NULL OR u.COD_USUARIO = p_cod_usuario)
      AND (p_cod_empleado IS NULL OR u.COD_EMPLEADO = p_cod_empleado)
      AND (p_cod_rol IS NULL OR u.COD_ROL = p_cod_rol);
END //
DELIMITER ;
CALL sp_ListarUsuarios(NULL,NULL,NULL);

DROP PROCEDURE IF EXISTS sp_ListarUsuarios
-- PROCEDIMIENTOS CONTRASEÑA
DELIMITER //
CREATE PROCEDURE sp_InsertarHistorialContrasena(
    IN P_COD_USUARIO BIGINT, 
    IN P_CONTRASENA TEXT
)
BEGIN
    DECLARE V_EXISTE INT DEFAULT 0;

    SELECT COUNT(*) INTO V_EXISTE FROM HISTCONTRASENA WHERE COD_USUARIO = P_COD_USUARIO AND CONTRASENA = P_CONTRASENA;
    IF V_EXISTE > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: No puedes usar una contraseña que ya usaste anteriormente.';
    ELSE
        INSERT INTO HISTCONTRASENA (COD_USUARIO, CONTRASENA, FECHA_CREA)
        VALUES (P_COD_USUARIO, P_CONTRASENA, NOW());
    END IF;
END //
DELIMITER ;
CALL sp_InsertarHistorialContrasena(1, 'Oz.1970');

-- ELIMINAR CONTRASEÑA
DELIMITER //
CREATE PROCEDURE sp_EliminarHistorialContrasenas(
    IN P_COD_USUARIO BIGINT
)
BEGIN
    DELETE FROM HISTCONTRASENA
    WHERE  COD_HISTCONTRASENA NOT IN (
        SELECT  COD_HISTCONTRASENA 
        FROM (SELECT COD_HISTCONTRASENA FROM HISTCONTRASENA WHERE COD_USUARIO = P_COD_USUARIO 
              ORDER BY FECHA_CREA DESC 
              LIMIT 10) AS subquery
    ) AND COD_USUARIO = P_COD_USUARIO;
END //
DELIMITER ;
CALL sp_EliminarHistorialContrasenas(2);


-- TABLA LISTAR HISTORIAL CONTRASEÑA
DELIMITER //
CREATE PROCEDURE sp_ListarHistorialContrasenas(
    IN P_COD_USUARIO BIGINT
)
BEGIN
    SELECT 
        h.COD_HISTCONTRASENA, 
        h.COD_USUARIO, 
        u.NOMBRE_USUARIO, 
        h.CONTRASENA, 
        h.FECHA_CREA 
    FROM HISTCONTRASENA h
    INNER JOIN USUARIOS u ON h.COD_USUARIO = u.COD_USUARIO
    WHERE h.COD_USUARIO = P_COD_USUARIO
    ORDER BY h.FECHA_CREA DESC;
END //
DELIMITER ;
CALL sp_ListarHistorialContrasenas(1);

-- PROCEDIMIENTOS PARAMETROS 
-- INSERTAR PARAMETROS 
DELIMITER //
CREATE PROCEDURE sp_InsertarParametro(
    IN P_PARAMETRO VARCHAR(50),
    IN P_VALOR VARCHAR(255),
    IN P_COD_USUARIO BIGINT
)
BEGIN
    INSERT INTO PARAMETROS (PARAMETRO, VALOR, COD_USUARIO)
    VALUES (P_PARAMETRO, P_VALOR, P_COD_USUARIO);
END //
DELIMITER ;
CALL sp_InsertarParametro('ADMIN_INTENTOS', '3', 1);
CALL sp_InsertarParametro('ADMIN_CUSER', 'USUARIO', 1);
CALL sp_InsertarParametro('ADMIN_CPASS', 'PASSWORD', 1);
CALL sp_InsertarParametro('ADMIN_VIGENCIA', '30', 1);
CALL sp_InsertarParametro('SYS_NOMBRE', 'SISTEMA SIGAL', 1);

-- ACTUALIZAR PARAMETRO 
DELIMITER //
CREATE PROCEDURE sp_ActualizarParametro(
    IN p_COD_PARAMETRO INT,
    IN p_PARAMETRO VARCHAR(50),
    IN p_VALOR VARCHAR(255),
    IN p_COD_USUARIO INT
)
BEGIN
    UPDATE PARAMETROS 
    SET PARAMETRO = p_PARAMETRO, 
        VALOR = p_VALOR,
        COD_USUARIO = p_COD_USUARIO,
        FECHA_MODIFICADO = NOW()
    WHERE COD_PARAMETRO = p_COD_PARAMETRO;
END //
DELIMITER ;
CALL sp_ActualizarParametro(1, 'ADMIN_INTENTOS', '5', 1);

-- ELIMINAR PARAMETRO
DELIMITER //
CREATE PROCEDURE sp_EliminarParametro(
    IN p_COD_PARAMETRO INT
)
BEGIN
    DELETE FROM PARAMETROS WHERE COD_PARAMETRO = p_COD_PARAMETRO;
END //
DELIMITER ;
CALL sp_EliminarParametro(5);

-- LISTAR PARAMETRO
DELIMITER //
CREATE PROCEDURE sp_ListarParametros()
BEGIN
    SELECT COD_PARAMETRO, PARAMETRO, VALOR, COD_USUARIO, FECHA_CREADO, FECHA_MODIFICADO
    FROM PARAMETROS;

END //
DELIMITER ;
CALL sp_ListarParametros();

-- PROCEDIMIENTOS MATERIALES 
-- INSERTAR MATERIAL
DELIMITER //
CREATE PROCEDURE sp_InsertarMaterial(
    IN p_codigo VARCHAR(10),
    IN p_material VARCHAR(30)
)
BEGIN
    IF EXISTS (SELECT 1 FROM MATERIALES WHERE CODIGO = p_codigo) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El código del material ya existe.';
    END IF;

    IF EXISTS (SELECT 1 FROM MATERIALES WHERE MATERIAL = p_material) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El material ya está registrado.';
    END IF;

    INSERT INTO MATERIALES (CODIGO, MATERIAL)
    VALUES (p_codigo, p_material);

    INSERT INTO INVENTARIOMATERIALES (MATERIAL_CODIGO, STOCK_ACTUAL, STOCK_MINIMO)
    VALUES (p_codigo, 0, 10);

    SELECT 'Material registrado correctamente' AS mensaje;
END //
DELIMITER ;
CALL sp_InsertarMaterial('CU', 'CUERO');
CALL sp_InsertarMaterial('HI', 'HILO');
CALL sp_InsertarMaterial('PE', 'PEGAMENTO');
CALL sp_InsertarMaterial('BR', 'BROCHE');
select*from inventariomateriales
-- ELIMINAR MATERIAL
DELIMITER //
CREATE PROCEDURE sp_EliminarMaterial(
    IN p_codigo VARCHAR(10)
)
BEGIN
    IF EXISTS (SELECT 1 FROM INVENTARIOMATERIALES WHERE MATERIAL_CODIGO = p_codigo) THEN
       
        DELETE FROM INVENTARIOMATERIALES WHERE MATERIAL_CODIGO = p_codigo;
    END IF;

    DELETE FROM MATERIALES WHERE CODIGO = p_codigo;

    SELECT 'Material eliminado correctamente.' AS mensaje;
END //
DELIMITER ; 


-- LISTAR MATERIALES 
DELIMITER //
CREATE PROCEDURE sp_ListarMateriales(
IN p_codigo VARCHAR(50), 
IN p_material VARCHAR(100))
BEGIN
    SELECT CODIGO, MATERIAL    
    FROM MATERIALES
    WHERE (CODIGO LIKE CONCAT('%', p_codigo, '%') OR p_codigo IS NULL)    
    AND (MATERIAL LIKE CONCAT('%', p_material, '%') OR p_material IS NULL);
END //DELIMITER ;
CALL sp_ListarMateriales(NULL, NULL);

-- TRIGGER ACTUALIZAR TOTAL FACTURA DESPUES DE INSERTAR
DELIMITER //
CREATE TRIGGER trg_ActualizarTotalFactura_After_Insert
AFTER INSERT ON DETALLECOMPRA
FOR EACH ROW
BEGIN
    UPDATE FACTURASCOMPRA
    SET SUBTOTAL = (SELECT COALESCE(SUM(SUBTOTAL), 0) 
                    FROM DETALLECOMPRA 
                    WHERE CODIGO_FACTURA = NEW.CODIGO_FACTURA)
    WHERE COD_FACTURA = NEW.CODIGO_FACTURA;
END //
DELIMITER ;

-- TRIGGER ACTUALIZAR TOTAL FACTURA DESPUES DE ACTUALIZAR
DELIMITER //
CREATE TRIGGER trg_ActualizarTotalFactura_After_Update
AFTER UPDATE ON DETALLECOMPRA
FOR EACH ROW
BEGIN
    UPDATE FACTURASCOMPRA
    SET SUBTOTAL = (SELECT COALESCE(SUM(SUBTOTAL), 0) 
                    FROM DETALLECOMPRA 
                    WHERE CODIGO_FACTURA = NEW.CODIGO_FACTURA)
    WHERE COD_FACTURA = NEW.CODIGO_FACTURA;
END //
DELIMITER ;


-- TRIGGER ACTUALIZAR TOTAL FACTURA DESPUES DE BORRAR
DELIMITER //
CREATE TRIGGER trg_ActualizarTotalFactura_After_Delete
AFTER DELETE ON DETALLECOMPRA
FOR EACH ROW
BEGIN
    UPDATE FACTURASCOMPRA
    SET SUBTOTAL = (SELECT COALESCE(SUM(SUBTOTAL), 0) 
                    FROM DETALLECOMPRA 
                    WHERE CODIGO_FACTURA = OLD.CODIGO_FACTURA)
    WHERE COD_FACTURA = OLD.CODIGO_FACTURA;
END //
DELIMITER ;

-- PROCEDIMIENTOS FACTURA COMPRA
-- INSERTAR FACTURA COMPRA
DELIMITER //
CREATE PROCEDURE sp_InsertarFacturaCompra(
    IN p_numero_factura VARCHAR(10),
    IN p_cod_proveedor INT,
    IN p_impuesto DECIMAL(10,2),
    IN p_descuento DECIMAL(10,2)
)
BEGIN
    IF NOT EXISTS (SELECT 1 FROM PROVEEDORES WHERE COD_PROVEEDORES = p_cod_proveedor) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El proveedor no existe.';
    END IF;
    
      SET p_impuesto = p_impuesto / 100;
    SET p_descuento = p_descuento / 100;

    INSERT INTO FACTURASCOMPRA (NUMERO_FACTURA, COD_PROVEEDORES, IMPUESTO, DESCUENTO)
    VALUES (p_numero_factura, p_cod_proveedor, p_impuesto, p_descuento);
    
    SELECT LAST_INSERT_ID() AS COD_FACTURA;
END //
DELIMITER ;


CALL sp_InsertarFacturaCompra('FAC-0001', 1, 0.15, 0.10);
CALL sp_InsertarFacturaCompra('FAC-0002', 1, 0.15, 0.10);

-- ELIMINAR FACTURA COMPRA
DELIMITER //
CREATE PROCEDURE sp_EliminarFacturaCompra(
    IN p_numero_factura VARCHAR(10)
)
BEGIN
    DECLARE v_cod_factura INT;
    
    SELECT COD_FACTURA INTO v_cod_factura
    FROM FACTURASCOMPRA
    WHERE NUMERO_FACTURA = p_numero_factura
    LIMIT 1;

    IF v_cod_factura IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: La factura no existe.';
    END IF;

    DELETE FROM DETALLECOMPRA
    WHERE CODIGO_FACTURA = v_cod_factura;

    DELETE FROM FACTURASCOMPRA
    WHERE COD_FACTURA = v_cod_factura;

    SELECT 'Factura eliminada correctamente' AS mensaje;
END //
DELIMITER ;

-- INSERTAR DETALLE COMPRA 
DELIMITER //
CREATE PROCEDURE sp_InsertarDetalleCompra(
    IN p_numero_factura VARCHAR(20),
    IN p_material_codigo VARCHAR(10),
    IN p_cantidad DECIMAL(10,2),
    IN p_precio DECIMAL(10,2)
)
BEGIN
    DECLARE v_cod_factura INT;

    SELECT COD_FACTURA INTO v_cod_factura
    FROM FACTURASCOMPRA
    WHERE NUMERO_FACTURA = p_numero_factura
    LIMIT 1;

    IF v_cod_factura IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: La factura no existe.';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM MATERIALES WHERE CODIGO = p_material_codigo) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El material no existe.';
    END IF;

    INSERT INTO DETALLECOMPRA (CODIGO_FACTURA, MATERIAL_CODIGO, CANTIDAD, PRECIO)
    VALUES (v_cod_factura, p_material_codigo, p_cantidad, p_precio);
    
    UPDATE INVENTARIOMATERIALES
    SET STOCK_ACTUAL = STOCK_ACTUAL + p_cantidad
    WHERE MATERIAL_CODIGO = p_material_codigo;

    SELECT 'Detalle de compra registrado y stock actualizado' AS mensaje;
END //
DELIMITER ;
CALL sp_InsertarDetalleCompra('FAC-0001', 'CU', 5, 10.00);
CALL sp_InsertarDetalleCompra('FAC-0002', 'HI', 5, 10.00);

-- ELIMINAR DETALLE COMPRA
DELIMITER //
CREATE PROCEDURE sp_EliminarDetalleCompra(
    IN p_codigo_factura INT,
    IN p_material_codigo VARCHAR(10)
)
BEGIN
    DECLARE v_stock_actual DECIMAL(10,2);
    DECLARE v_cantidad DECIMAL(10,2);

    IF NOT EXISTS (SELECT 1 FROM DETALLECOMPRA 
                   WHERE CODIGO_FACTURA = p_codigo_factura 
                   AND MATERIAL_CODIGO = p_material_codigo) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El detalle de compra no existe.';
    END IF;

    SELECT CANTIDAD INTO v_cantidad
    FROM DETALLECOMPRA
    WHERE CODIGO_FACTURA = p_codigo_factura 
    AND MATERIAL_CODIGO = p_material_codigo;

    IF NOT EXISTS (SELECT 1 FROM INVENTARIOMATERIALES WHERE MATERIAL_CODIGO = p_material_codigo) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El material no existe en inventario.';
    END IF;

    SELECT STOCK_ACTUAL INTO v_stock_actual
    FROM INVENTARIOMATERIALES
    WHERE MATERIAL_CODIGO = p_material_codigo;

    DELETE FROM DETALLECOMPRA
    WHERE CODIGO_FACTURA = p_codigo_factura 
    AND MATERIAL_CODIGO = p_material_codigo;
    
    UPDATE INVENTARIOMATERIALES
    SET STOCK_ACTUAL = v_stock_actual - v_cantidad
    WHERE MATERIAL_CODIGO = p_material_codigo;
    
    SELECT 'Detalle de compra eliminado correctamente y stock actualizado' AS mensaje;
END //
DELIMITER ;

-- LISTAR DETALLE COMPRA
-- LISTAR FACTURAS MATERIALES 
DELIMITER //
CREATE PROCEDURE sp_ListarFacturas(
IN p_proveedor VARCHAR(100), 
IN p_numero_factura VARCHAR(50))
BEGIN
    SELECT         
    f.NUMERO_FACTURA,
        pr.NOMBRE_EMPRESA,       
        f.FECHA,
        f.TOTAL    
        FROM 
        FACTURASCOMPRA f    
        JOIN 
        PROVEEDORES pr ON f.COD_PROVEEDORES = pr.COD_PROVEEDORES   
        WHERE 
        (pr.NOMBRE_EMPRESA LIKE CONCAT('%', p_proveedor, '%') OR p_proveedor IS NULL)    AND 
        (f.NUMERO_FACTURA LIKE CONCAT('%', p_numero_factura, '%') OR p_numero_factura IS NULL);
        
        END //
DELIMITER ;
CALL sp_ListarFacturas (NULL,NULL);
-- LISTAR DETALLE COMPRA 
DELIMITER //
CREATE PROCEDURE sp_ListarDetalleCompra(   
 IN p_numero_factura VARCHAR(20),   
    IN p_nombre_empresa VARCHAR(100))
BEGIN    
SELECT 
        F.NUMERO_FACTURA,         
        P.NOMBRE_EMPRESA, 
        F.FECHA,         
        D.MATERIAL_CODIGO, 
        D.CANTIDAD,        
        D.PRECIO, 
        D.SUBTOTAL,        
        F.IMPUESTO, 
        F.DESCUENTO,        
        F.TOTAL
    FROM DETALLECOMPRA D    
    JOIN FACTURASCOMPRA F ON D.CODIGO_FACTURA = F.COD_FACTURA
    JOIN PROVEEDORES P ON F.COD_PROVEEDORES = P.COD_PROVEEDORES    
    WHERE 
        (p_numero_factura IS NULL OR p_numero_factura = '' OR F.NUMERO_FACTURA = p_numero_factura)    AND 
        (p_nombre_empresa IS NULL OR p_nombre_empresa = '' OR P.NOMBRE_EMPRESA LIKE CONCAT('%', p_nombre_empresa, '%'))    ORDER BY F.NUMERO_FACTURA;
END 
//DELIMITER ;
CALL sp_ListarDetalleCompra(NULL, NULL);    CALL sp_ListarDetalleCompra('F12345', NULL);   
CALL sp_ListarDetalleCompra(NULL, 'ABC'); CALL sp_ListarDetalleCompra('FAC-0001', 'ABC');

-- SALIDA MATERIAL
DELIMITER //
CREATE PROCEDURE sp_SalidaMaterial(
    IN p_codigo VARCHAR(10),
    IN p_cantidad DECIMAL(10,2)
)
BEGIN
    DECLARE v_stock_actual DECIMAL(10,2);
    START TRANSACTION;
    IF NOT EXISTS (SELECT 1 FROM INVENTARIOMATERIALES WHERE MATERIAL_CODIGO = p_codigo) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El material no existe en el inventario.';
    END IF;
    
    SELECT STOCK_ACTUAL INTO v_stock_actual
    FROM INVENTARIOMATERIALES
    WHERE MATERIAL_CODIGO = p_codigo
    FOR UPDATE; 
    
    IF v_stock_actual < p_cantidad THEN
        ROLLBACK;
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: Stock insuficiente para la salida.';
    END IF;
    
    UPDATE INVENTARIOMATERIALES
    SET STOCK_ACTUAL = STOCK_ACTUAL - p_cantidad
    WHERE MATERIAL_CODIGO = p_codigo;
    
    COMMIT;
    SELECT CONCAT('Salida de ', p_cantidad, ' unidades de material ', p_codigo, ' registrada correctamente.') AS mensaje;
END
// DELIMITER ;
CALL sp_SalidaMaterial('CU', 5);

-- LISTAR INVENTARIO
-- LISTAR INVENTARIO
DELIMITER //
CREATE PROCEDURE sp_ListarInventario(   
 IN p_material_codigo VARCHAR(20),    -- Parámetro de entrada para el código del material
    IN p_nombre_material VARCHAR(100),   -- Parámetro de entrada para el nombre del material    
    IN p_stock_minimo BOOLEAN )
BEGIN
    SELECT         
    IM.MATERIAL_CODIGO,
        M.MATERIAL AS NOMBRE_MATERIAL,        
        IM.STOCK_ACTUAL,
        IM.STOCK_MINIMO    
        FROM 
        INVENTARIOMATERIALES IM    
        JOIN 
        MATERIALES M ON IM.MATERIAL_CODIGO = M.CODIGO   
        WHERE
        (p_material_codigo IS NULL OR p_material_codigo = '' OR IM.MATERIAL_CODIGO = p_material_codigo)    AND 
        (p_nombre_material IS NULL OR p_nombre_material = '' OR M.MATERIAL LIKE CONCAT('%', p_nombre_material, '%'))    AND 
        (p_stock_minimo IS NULL OR p_stock_minimo = FALSE OR IM.STOCK_ACTUAL < IM.STOCK_MINIMO)    ORDER BY 
        IM.MATERIAL_CODIGO;
        END //
DELIMITER ;
CALL sp_ListarInventario(NULL, NULL, NULL);

DELIMITER //
CREATE PROCEDURE sp_AutenticarUsuario(
    IN p_nombre_usuario VARCHAR(255))
BEGIN
    DECLARE v_cod_usuario BIGINT;
    DECLARE v_contrasena_hash VARCHAR(2000);
    DECLARE v_cod_rol BIGINT;
    DECLARE v_nombre_rol VARCHAR(255);
    DECLARE v_estado ENUM('1', '0');

    -- Obtener el usuario y verificar si existe
    SELECT COD_USUARIO, CONTRASENA, COD_ROL, ESTADO_USUARIO
    INTO v_cod_usuario, v_contrasena_hash, v_cod_rol, v_estado
    FROM USUARIOS
    WHERE NOMBRE_USUARIO = p_nombre_usuario;

    -- Verificar si el usuario existe
    IF v_cod_usuario IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: Usuario no encontrado.';
    END IF;

    -- Verificar si la cuenta está activa
    IF v_estado = '0' THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: Cuenta desactivada.';
    END IF;

    -- Obtener nombre del rol
    SELECT NOMBRE_ROL INTO v_nombre_rol FROM ROLES WHERE COD_ROL = v_cod_rol;

    -- Devolver la información del usuario y la contraseña hasheada para compararla en Node.js
    SELECT v_cod_usuario AS COD_USUARIO, p_nombre_usuario AS NOMBRE_USUARIO, v_contrasena_hash AS CONTRASENA, v_cod_rol AS COD_ROL, v_nombre_rol AS ROL;
END //
DELIMITER ;

-- INSERTAR SUCURSAL
DELIMITER //
CREATE PROCEDURE sp_InsertarSucursales(
    IN p_nombre VARCHAR(50),
    IN p_direccion VARCHAR(100),
    IN p_cod_empleado_encargado INT
)
BEGIN
    INSERT INTO SUCURSALES(NOMBRE, DIRECCION, COD_EMPLEADO_ENCARGADO)
    VALUES(p_nombre, p_direccion, p_cod_empleado_encargado);
    SELECT LAST_INSERT_ID() AS COD_SUCURSAL;
END //
DELIMITER ;
CALL sp_InsertarSucursales('Sucursal City Mall', 'Quisco City mall frente Charly', 1);
CALL sp_InsertarSucursales('Sucursal Santa Lucia', 'Calle principal', 2);
CALL sp_InsertarSucursales('Sucursal Plaza Miraflores', 'Primer piso del mall', 3);



DELIMITER //
CREATE PROCEDURE sp_ActualizarSucursal(
    IN p_cod_sucursal INT,
    IN p_nombre VARCHAR(50),
    IN p_direccion VARCHAR(100),
    IN p_cod_empleado_encargado INT
)
BEGIN
    UPDATE SUCURSALES 
    SET NOMBRE = p_nombre,
        DIRECCION = p_direccion,
        COD_EMPLEADO_ENCARGADO = p_cod_empleado_encargado
    WHERE COD_SUCURSAL = p_cod_sucursal;
    SELECT E.COD_EMPLEADO, 
           CONCAT(P.PRIMER_NOMBRE, ' ', P.PRIMER_APELLIDO) AS NOMBRE_ENCARGADO, 
           T.NUMERO_TELEFONO 
    FROM EMPLEADOS E
    JOIN PERSONAS P ON E.COD_PERSONA = P.COD_PERSONA
    LEFT JOIN TELEFONOS T ON P.COD_PERSONA = T.COD_PERSONA
    WHERE E.COD_EMPLEADO = p_cod_empleado_encargado;
END //
DELIMITER ;



DELIMITER //

CREATE PROCEDURE sp_ListarSucursales(
    IN p_cod_sucursal INT,
    IN p_nombre_sucursal VARCHAR(100),
    IN p_nombre_empleado VARCHAR(100)
)
BEGIN
    SELECT 
        s.COD_SUCURSAL,
        s.NOMBRE AS NOMBRE_SUCURSAL,
        s.DIRECCION,
        CONCAT(p.PRIMER_NOMBRE, ' ', p.PRIMER_APELLIDO) AS NOMBRE_ENCARGADO,
        t.NUMERO_TELEFONO AS TELEFONO_ENCARGADO,
        s.COD_EMPLEADO_ENCARGADO AS COD_EMPLEADO,
        es.ESTADO  -- Nueva columna
    FROM SUCURSALES s
    LEFT JOIN EMPLEADOS e ON s.COD_EMPLEADO_ENCARGADO = e.COD_EMPLEADO
    LEFT JOIN PERSONAS p ON e.COD_PERSONA = p.COD_PERSONA
    LEFT JOIN TELEFONOS t ON p.COD_PERSONA = t.COD_PERSONA AND t.TIPO_TELEFONO = 'PERSONAL'
    LEFT JOIN estado_sucursales es ON s.COD_SUCURSAL = es.COD_SUCURSAL
    WHERE (p_cod_sucursal IS NULL OR s.COD_SUCURSAL = p_cod_sucursal)
      AND (p_nombre_sucursal IS NULL OR s.NOMBRE LIKE CONCAT('%', p_nombre_sucursal, '%'))
      AND (p_nombre_empleado IS NULL OR CONCAT(p.PRIMER_NOMBRE, ' ', p.PRIMER_APELLIDO) LIKE CONCAT('%', p_nombre_empleado, '%'))
    ORDER BY s.NOMBRE;
END //

DELIMITER ;



DELIMITER //

CREATE PROCEDURE sp_CambiarEstadoSucursal(
    IN p_cod_sucursal INT,
    IN p_estado ENUM('ACTIVA', 'INACTIVA')
)
BEGIN
    -- Verificar si el registro existe
    IF EXISTS (SELECT 1 FROM estado_sucursales WHERE COD_SUCURSAL = p_cod_sucursal) THEN
        -- Actualizar el estado existente
        UPDATE estado_sucursales 
        SET ESTADO = p_estado
        WHERE COD_SUCURSAL = p_cod_sucursal;
    ELSE
        -- Insertar un nuevo registro si no existe
        INSERT INTO estado_sucursales (COD_SUCURSAL, ESTADO)
        VALUES (p_cod_sucursal, p_estado);
    END IF;
END //

DELIMITER ;


-- INSERTAR CATEGORIA
DELIMITER //
CREATE PROCEDURE sp_InsertarCategoria(
    IN p_nombre VARCHAR(50),
    IN p_descripcion VARCHAR(100)
)
BEGIN
    INSERT INTO CATEGORIAS(NOMBRE, DESCRIPCION)
    VALUES(p_nombre, p_descripcion);
    SELECT LAST_INSERT_ID() AS COD_CATEGORIA;
END //
DELIMITER ;

CALL sp_InsertarCategoria('Carteras', 'Carteras para dama');
CALL sp_InsertarCategoria('Billeteras', 'Carteras para Hombre');
CALL sp_InsertarCategoria('Fajas', 'Cinturon para Hombre');

-- ACTUALIZAR CATEGORIA 
DELIMITER //
CREATE PROCEDURE sp_ActualizarCategoria(
    IN p_cod_categoria INT,
    IN p_nombre VARCHAR(50),
    IN p_descripcion VARCHAR(100)
)
BEGIN
    UPDATE CATEGORIAS
    SET NOMBRE = p_nombre,
        DESCRIPCION = p_descripcion
    WHERE COD_CATEGORIA = p_cod_categoria;
    
    SELECT COD_CATEGORIA, NOMBRE, DESCRIPCION
    FROM CATEGORIAS
    WHERE COD_CATEGORIA = p_cod_categoria;
END //
DELIMITER ;



-- Procedimiento de Lista Categorias

DELIMITER //
CREATE PROCEDURE sp_ListarCategorias(
    IN p_cod_categoria INT,
    IN p_nombre_categoria VARCHAR(50)
)
BEGIN
    IF p_cod_categoria IS NOT NULL AND p_nombre_categoria IS NOT NULL THEN
        -- Filtrar por ambos: código y nombre
        SELECT COD_CATEGORIA, NOMBRE, DESCRIPCION
        FROM CATEGORIAS
        WHERE COD_CATEGORIA = p_cod_categoria
        AND NOMBRE LIKE CONCAT('%', p_nombre_categoria, '%');
    ELSEIF p_cod_categoria IS NOT NULL THEN
        -- Filtrar solo por código
        SELECT COD_CATEGORIA, NOMBRE, DESCRIPCION
        FROM CATEGORIAS
        WHERE COD_CATEGORIA = p_cod_categoria;
    ELSEIF p_nombre_categoria IS NOT NULL THEN
        -- Filtrar solo por nombre
        SELECT COD_CATEGORIA, NOMBRE, DESCRIPCION
        FROM CATEGORIAS
        WHERE NOMBRE LIKE CONCAT('%', p_nombre_categoria, '%');
    ELSE
        -- Listar todo si ambos parámetros son NULL
        SELECT COD_CATEGORIA, NOMBRE, DESCRIPCION
        FROM CATEGORIAS;
    END IF;
END //
DELIMITER ;

-- ELIMINAR CATEGORIA
DELIMITER //
CREATE PROCEDURE sp_EliminarCategoria(
    IN p_cod_categoria INT
)
BEGIN
    -- Verificar si la categoría existe antes de eliminarla
    IF EXISTS (SELECT 1 FROM CATEGORIAS WHERE COD_CATEGORIA = p_cod_categoria) THEN
        DELETE FROM CATEGORIAS WHERE COD_CATEGORIA = p_cod_categoria;
        SELECT 'Categoría eliminada correctamente' AS Mensaje;
    ELSE
        SELECT 'Error: La categoría no existe' AS Mensaje;
    END IF;
END //
DELIMITER ;

CALL sp_ListarCategorias(NULL,NULL);
CALL sp_ListarCategorias('Carteras');

-- INSERTAR PRODUCTO
DELIMITER //
CREATE PROCEDURE sp_InsertarProducto(
    IN p_codigo VARCHAR(15),
    IN p_modelo VARCHAR(50),
    IN p_descripcion VARCHAR(200),
    IN p_cod_categoria INT,
    IN p_precio_venta DECIMAL(10,2),
    IN p_tiempo_garantia INT
)
BEGIN
    INSERT INTO PRODUCTOS(CODIGO, MODELO, DESCRIPCION, COD_CATEGORIA, TIEMPO_GARANTIA)
    VALUES(p_codigo, p_modelo, p_descripcion, p_cod_categoria, p_tiempo_garantia);
    
    SELECT LAST_INSERT_ID() AS COD_PRODUCTO;
END //
DELIMITER ;

CALL sp_InsertarProducto('ISMARY-01', 'Ismary', 'Cartera grande color antic', 2, 1500.00, 6);
CALL sp_InsertarProducto('DANIELA-01', 'Dani', 'Cartera grande color rojo', 1, 1200.00, 6);
CALL sp_InsertarProducto('DANILO-01', 'Danilo', 'Cartera color antic miel triple', 2, 400.00, 0);
CALL sp_InsertarProducto('FAJA-01', 'Faja', 'Faja cafe doble', 3, 300.00, 0);

-- ACTUALIZAR PRODUCTO
DELIMITER //
CREATE PROCEDURE sp_ActualizarProducto(
    IN p_cod_producto INT,
    IN p_codigo VARCHAR(15),
    IN p_modelo VARCHAR(50),
    IN p_descripcion VARCHAR(200),
    IN p_cod_categoria INT,
    IN p_tiempo_garantia INT
)
BEGIN
    DECLARE v_codigo_anterior VARCHAR(15);

    SELECT CODIGO INTO v_codigo_anterior
    FROM PRODUCTOS
    WHERE COD_PRODUCTO = p_cod_producto;

    UPDATE PRODUCTOS
    SET 
        CODIGO = p_codigo,
        MODELO = p_modelo,
        DESCRIPCION = p_descripcion,
        COD_CATEGORIA = p_cod_categoria,
        TIEMPO_GARANTIA = p_tiempo_garantia
    WHERE COD_PRODUCTO = p_cod_producto;

    IF v_codigo_anterior <> p_codigo THEN
        UPDATE INVENTARIOPRODUCTOS
        SET COD_PRODUCTO = p_cod_producto
        WHERE COD_PRODUCTO = p_cod_producto;
    END IF;

    SELECT 'Producto actualizado correctamente' AS MENSAJE;
END //
DELIMITER ;
CALL sp_ActualizarProducto(1, 'ISMARY-01', 'Ismary', 'Cartera grande color antic miel', 1, 12);

-- LISTAR PRODUCTO
DELIMITER //
CREATE PROCEDURE sp_ListarProductos(
    IN p_codigo VARCHAR(15)
)
BEGIN
    IF p_codigo IS NOT NULL THEN
        -- Filtrar por código de producto y unir con CATEGORIAS
        SELECT 
            p.COD_PRODUCTO, 
            p.CODIGO, 
            p.MODELO, 
            p.DESCRIPCION, 
            c.NOMBRE AS NOMBRE_CATEGORIA, 
            p.TIEMPO_GARANTIA
        FROM PRODUCTOS p
        LEFT JOIN CATEGORIAS c ON p.COD_CATEGORIA = c.COD_CATEGORIA
        WHERE p.CODIGO = p_codigo;
    ELSE
        -- Listar todos los productos y unir con CATEGORIAS
        SELECT 
            p.COD_PRODUCTO, 
            p.CODIGO, 
            p.MODELO, 
            p.DESCRIPCION, 
            c.NOMBRE AS NOMBRE_CATEGORIA, 
            p.TIEMPO_GARANTIA
        FROM PRODUCTOS p
        LEFT JOIN CATEGORIAS c ON p.COD_CATEGORIA = c.COD_CATEGORIA;
    END IF;
END //
DELIMITER ;
CALL sp_ListarProductos(NULL);
CALL sp_ListarProductos('ISMARY-01');


-- ELIMINAR PRODUCTO
DELIMITER //
CREATE PROCEDURE sp_EliminarProducto(
    IN p_cod_producto INT
)
BEGIN
    -- Verificar si el producto existe antes de eliminarlo
    IF EXISTS (SELECT 1 FROM PRODUCTOS WHERE COD_PRODUCTO = p_cod_producto) THEN
        -- Eliminar el producto
        DELETE FROM PRODUCTOS
        WHERE COD_PRODUCTO = p_cod_producto;

        SELECT 'Producto eliminado correctamente' AS MENSAJE;
    ELSE
        SELECT 'Error: El producto no existe' AS MENSAJE;
    END IF;
END //
DELIMITER ;


DELIMITER //
CREATE PROCEDURE sp_Estadisticas()
BEGIN
    -- Declarar todas las variables al inicio
    DECLARE total_compras DECIMAL(12,2);
    DECLARE total_materiales INT;
    DECLARE stock_bajo INT;

    -- Total de Compras (suma de los totales de las facturas)
    SELECT COALESCE(SUM(TOTAL), 0) INTO total_compras 
    FROM FACTURASCOMPRA;

    -- Total de Materiales (número de materiales registrados)
    SELECT COUNT(*) INTO total_materiales 
    FROM MATERIALES;

    -- Materiales con Stock Bajo (stock actual menor al mínimo)
    SELECT COUNT(*) INTO stock_bajo 
    FROM INVENTARIOMATERIALES 
    WHERE STOCK_ACTUAL < STOCK_MINIMO;

    -- Devolver los resultados
    SELECT 
        total_compras AS total_compras,
        total_materiales AS total_materiales,
        stock_bajo AS stock_bajo;
END //

DELIMITER ;


-- INSERTAR PRODUCTO INVENTARIO (Usando COD_PRODUCTO en lugar de CODIGO)
DELIMITER //
CREATE PROCEDURE sp_InsertarProductoInventario(
    IN p_cod_producto INT,
    IN p_cod_sucursal INT,
    IN p_cantidad DECIMAL(10,2),
    IN p_stock_minimo DECIMAL(10,2),
    IN p_precio_venta DECIMAL(10,2)
)
BEGIN
    -- Verificar si el producto ya está en el inventario
    IF EXISTS (
        SELECT 1 FROM INVENTARIOPRODUCTOS 
        WHERE COD_PRODUCTO = p_cod_producto 
        AND COD_SUCURSAL = p_cod_sucursal
    ) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El producto ya está registrado en esta sucursal';
    ELSE
        -- Insertar en el inventario si no existe
        INSERT INTO INVENTARIOPRODUCTOS (COD_PRODUCTO, COD_SUCURSAL, STOCK_ACTUAL, STOCK_MINIMO, PRECIO_VENTA)
        VALUES (p_cod_producto, p_cod_sucursal, p_cantidad, p_stock_minimo, p_precio_venta);
        
        SELECT 'Producto agregado al inventario correctamente' AS MENSAJE;
    END IF;
END //
DELIMITER ;


CALL sp_InsertarProductoInventario('2', 1, 50, 10, 1900.00);
CALL sp_InsertarProductoInventario('DANIELA-01', 1, 50, 10, 1200.00);

CALL sp_InsertarProductoInventario('ISMARY-01', 2, 50, 10, 1600.00); -- Precio diferente en otra sucursal
CALL sp_InsertarProductoInventario('DANIELA-01', 2, 50, 10, 1300.00); -- Precio diferente en otra sucursal
CALL sp_InsertarProductoInventario('DANILO-01', 2, 50, 10, 400.00);

CALL sp_InsertarProductoInventario('FAJA-01', 3, 50, 10, 300.00);

-- ACTUALIZAR PRODUCTO INVENTARIO
DELIMITER //
CREATE PROCEDURE sp_ActualizarInventarioProducto(
    IN p_codigo_producto VARCHAR(15),  
    IN p_cod_sucursal INT,
    IN p_stock_minimo DECIMAL(10,2),
    IN p_precio_venta DECIMAL(10,2)
)
BEGIN
    -- Declarar variables al inicio del bloque
    DECLARE v_cod_producto INT;
    DECLARE v_existe INT;

    -- Obtener el COD_PRODUCTO basado en el código del producto
    SELECT COD_PRODUCTO INTO v_cod_producto
    FROM PRODUCTOS
    WHERE CODIGO = p_codigo_producto;

    -- Verificar si el producto existe
    IF v_cod_producto IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El producto no existe';
    ELSE
        -- Verificar si el producto existe en el inventario de la sucursal
        SELECT COUNT(*) INTO v_existe
        FROM INVENTARIOPRODUCTOS
        WHERE COD_PRODUCTO = v_cod_producto AND COD_SUCURSAL = p_cod_sucursal;

        IF v_existe = 0 THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'Error: El producto no existe en el inventario de la sucursal especificada';
        ELSE
            -- Actualizar el inventario (solo stock mínimo y precio de venta)
            UPDATE INVENTARIOPRODUCTOS
            SET 
                STOCK_MINIMO = p_stock_minimo,
                PRECIO_VENTA = p_precio_venta
            WHERE COD_PRODUCTO = v_cod_producto AND COD_SUCURSAL = p_cod_sucursal;

            SELECT 'Inventario actualizado correctamente' AS MENSAJE;
        END IF;
    END IF;
END //
DELIMITER ;
CALL sp_ActualizarInventarioProducto('ISMARY-01', 1, 15, 1400.00);

CALL sp_ActualizarInventarioProducto('DANIELA-01', 3, 15, 300.00); -- DESPUES DEL TRASLADO 

DELIMITER //
CREATE PROCEDURE sp_ListarInventarios(
    IN p_nombre_sucursal VARCHAR(255)
)
BEGIN
    IF p_nombre_sucursal IS NOT NULL THEN
        SELECT 
            p.CODIGO AS CODIGO_PRODUCTO,
            p.MODELO AS NOMBRE_PRODUCTO,
            p.DESCRIPCION,
            c.NOMBRE AS CATEGORIA,
            s.NOMBRE AS NOMBRE_SUCURSAL, -- Cambiado de s.NOMBRE_SUCURSAL a s.NOMBRE
            s.COD_SUCURSAL, -- Incluimos el ID de la sucursal
            ip.STOCK_ACTUAL,
            ip.STOCK_MINIMO,
            ip.PRECIO_VENTA
        FROM INVENTARIOPRODUCTOS ip
        INNER JOIN PRODUCTOS p ON ip.COD_PRODUCTO = p.COD_PRODUCTO
        INNER JOIN SUCURSALES s ON ip.COD_SUCURSAL = s.COD_SUCURSAL
        INNER JOIN CATEGORIAS c ON p.COD_CATEGORIA = c.COD_CATEGORIA
        WHERE s.NOMBRE = p_nombre_sucursal; -- Ajustado a s.NOMBRE
    ELSE
        SELECT 
            p.CODIGO AS CODIGO_PRODUCTO,
            p.MODELO AS NOMBRE_PRODUCTO,
            p.DESCRIPCION,
            c.NOMBRE AS CATEGORIA,
            s.NOMBRE AS NOMBRE_SUCURSAL, -- Cambiado de s.NOMBRE_SUCURSAL a s.NOMBRE
            s.COD_SUCURSAL, -- Incluimos el ID de la sucursal
            ip.STOCK_ACTUAL,
            ip.STOCK_MINIMO,
            ip.PRECIO_VENTA
        FROM INVENTARIOPRODUCTOS ip
        INNER JOIN PRODUCTOS p ON ip.COD_PRODUCTO = p.COD_PRODUCTO
        INNER JOIN SUCURSALES s ON ip.COD_SUCURSAL = s.COD_SUCURSAL
        INNER JOIN CATEGORIAS c ON p.COD_CATEGORIA = c.COD_CATEGORIA;
    END IF;
END //
DELIMITER ;
call sp_ListarInventarios("CITY MALL");



-- ELIMINAR PRODUCTO

DELIMITER //
CREATE PROCEDURE sp_EliminarProductoInventario(
    IN p_cod_producto INT, 
    IN p_cod_sucursal INT,  
    IN p_eliminar_completamente BOOLEAN
)
BEGIN
    DECLARE v_existe INT;

    -- Verificar si el producto existe
    SELECT COUNT(*) INTO v_existe
    FROM PRODUCTOS
    WHERE COD_PRODUCTO = p_cod_producto;

    IF v_existe = 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El producto no existe';
    ELSE
        IF p_eliminar_completamente = FALSE THEN
            -- Verificar si la sucursal existe
            SELECT COUNT(*) INTO v_existe
            FROM SUCURSALES
            WHERE COD_SUCURSAL = p_cod_sucursal;

            IF v_existe = 0 THEN
                SIGNAL SQLSTATE '45000'
                SET MESSAGE_TEXT = 'Error: La sucursal no existe';
            ELSE
                -- Verificar si el producto existe en el inventario de la sucursal
                SELECT COUNT(*) INTO v_existe
                FROM INVENTARIOPRODUCTOS
                WHERE COD_PRODUCTO = p_cod_producto AND COD_SUCURSAL = p_cod_sucursal;

                IF v_existe = 0 THEN
                    SIGNAL SQLSTATE '45000'
                    SET MESSAGE_TEXT = 'Error: El producto no existe en el inventario de la sucursal especificada';
                ELSE
                    DELETE FROM INVENTARIOPRODUCTOS
                    WHERE COD_PRODUCTO = p_cod_producto AND COD_SUCURSAL = p_cod_sucursal;

                    SELECT 'Producto eliminado del inventario de la sucursal correctamente' AS MENSAJE;
                END IF;
            END IF;
        ELSE
            DELETE FROM INVENTARIOPRODUCTOS
            WHERE COD_PRODUCTO = p_cod_producto;

            DELETE FROM PRODUCTOS
            WHERE COD_PRODUCTO = p_cod_producto;

            SELECT 'Producto y registros de inventario eliminados completamente' AS MENSAJE;
        END IF;
    END IF;
END //
DELIMITER ;

CALL sp_EliminarProducto('FAJA-01', 'Sucursal Plaza Miraflores', FALSE); -- FALSE Eliminar solo de una sucursal
CALL sp_EliminarProducto('FAJA-01', NULL, TRUE); -- TRUE Eliminar completamente

DELIMITER //

CREATE PROCEDURE sp_AgregarStockProducto(
    IN p_codigo VARCHAR(15),
    IN p_cod_sucursal INT,
    IN p_cantidad DECIMAL(10,2),
    OUT p_mensaje VARCHAR(255)
)
BEGIN
    DECLARE v_cod_producto INT;

    -- Buscar el COD_PRODUCTO correspondiente al CODIGO
    SELECT COD_PRODUCTO INTO v_cod_producto
    FROM PRODUCTOS
    WHERE CODIGO = p_codigo;

    -- Verificar si se encontró el producto
    IF v_cod_producto IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: No se encontró un producto con ese código';
    ELSE
        -- Verificar si el producto existe en el inventario de la sucursal
        IF EXISTS (
            SELECT 1 FROM INVENTARIOPRODUCTOS 
            WHERE COD_PRODUCTO = v_cod_producto 
            AND COD_SUCURSAL = p_cod_sucursal
        ) THEN
            -- Actualizar el stock actual sumando la cantidad
            UPDATE INVENTARIOPRODUCTOS
            SET STOCK_ACTUAL = STOCK_ACTUAL + p_cantidad
            WHERE COD_PRODUCTO = v_cod_producto 
            AND COD_SUCURSAL = p_cod_sucursal;

            SET p_mensaje = 'Stock agregado correctamente';
        ELSE
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'Error: El producto no está registrado en esta sucursal';
        END IF;
    END IF;
END //

DELIMITER ;
DROP PROCEDURE IF EXISTS sp_AgregarStockProducto


DELIMITER //

CREATE PROCEDURE sp_RealizarTraslado(
    IN p_COD_SUCURSAL_ORIGEN INT,
    IN p_COD_SUCURSAL_DESTINO INT,
    IN p_CODIGO_PRODUCTO INT,
    IN p_CANTIDAD DECIMAL(10,2),
    IN p_COD_USUARIO BIGINT,
    IN p_FECHA_TRASLADO DATE,
    IN p_NOTAS VARCHAR(255),
    OUT MENSAJE VARCHAR(255)
)
BEGIN
    DECLARE v_COD_TRASLADO INT;
    DECLARE v_STOCK_ACTUAL DECIMAL(10,2);

    -- Manejo de excepciones
    DECLARE EXIT HANDLER FOR SQLEXCEPTION 
    BEGIN
        SET MENSAJE = 'Error al realizar el traslado';
        ROLLBACK;
    END;

    -- Iniciar transacción
    START TRANSACTION;

    -- Verificar que las sucursales no sean iguales
    IF p_COD_SUCURSAL_ORIGEN = p_COD_SUCURSAL_DESTINO THEN
        SET MENSAJE = 'Las sucursales de origen y destino no pueden ser iguales';
        ROLLBACK;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = MENSAJE;
    END IF;

    -- Verificar que el producto exista
    IF NOT EXISTS (SELECT 1 FROM PRODUCTOS WHERE COD_PRODUCTO = p_CODIGO_PRODUCTO) THEN
        SET MENSAJE = 'El producto no existe';
        ROLLBACK;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = MENSAJE;
    END IF;

    -- Verificar que las sucursales existan
    IF NOT EXISTS (SELECT 1 FROM SUCURSALES WHERE COD_SUCURSAL = p_COD_SUCURSAL_ORIGEN) THEN
        SET MENSAJE = 'La sucursal de origen no existe';
        ROLLBACK;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = MENSAJE;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM SUCURSALES WHERE COD_SUCURSAL = p_COD_SUCURSAL_DESTINO) THEN
        SET MENSAJE = 'La sucursal de destino no existe';
        ROLLBACK;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = MENSAJE;
    END IF;

    -- Verificar que el usuario exista
    IF NOT EXISTS (SELECT 1 FROM USUARIOS WHERE COD_USUARIO = p_COD_USUARIO) THEN
        SET MENSAJE = 'El usuario no existe';
        ROLLBACK;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = MENSAJE;
    END IF;

    -- Verificar stock en origen
    SELECT STOCK_ACTUAL INTO v_STOCK_ACTUAL 
    FROM INVENTARIOPRODUCTOS 
    WHERE COD_PRODUCTO = p_CODIGO_PRODUCTO AND COD_SUCURSAL = p_COD_SUCURSAL_ORIGEN;

    IF v_STOCK_ACTUAL IS NULL OR v_STOCK_ACTUAL < p_CANTIDAD THEN
        SET MENSAJE = 'Stock insuficiente en la sucursal de origen';
        ROLLBACK;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = MENSAJE;
    END IF;

    -- Insertar el traslado
    INSERT INTO TRASLADOS (
        SUCURSAL_ORIGEN, 
        SUCURSAL_DESTINO, 
        FECHA_TRASLADO, 
        ESTADO, 
        NOTAS, 
        COD_USUARIO
    ) VALUES (
        p_COD_SUCURSAL_ORIGEN, 
        p_COD_SUCURSAL_DESTINO, 
        p_FECHA_TRASLADO, 
        'PENDIENTE', 
        p_NOTAS, 
        p_COD_USUARIO
    );

    -- Obtener el COD_TRASLADO recién insertado
    SET v_COD_TRASLADO = LAST_INSERT_ID();

    -- Insertar el detalle del traslado
    INSERT INTO DETALLETRASLADOS (
        COD_TRASLADO, 
        COD_PRODUCTO, 
        CANTIDAD
    ) VALUES (
        v_COD_TRASLADO, 
        p_CODIGO_PRODUCTO, 
        p_CANTIDAD
    );

    -- Actualizar inventario en origen
    UPDATE INVENTARIOPRODUCTOS 
    SET STOCK_ACTUAL = STOCK_ACTUAL - p_CANTIDAD 
    WHERE COD_PRODUCTO = p_CODIGO_PRODUCTO AND COD_SUCURSAL = p_COD_SUCURSAL_ORIGEN;

    -- Actualizar o insertar en destino
    IF EXISTS (SELECT 1 FROM INVENTARIOPRODUCTOS WHERE COD_PRODUCTO = p_CODIGO_PRODUCTO AND COD_SUCURSAL = p_COD_SUCURSAL_DESTINO) THEN
        UPDATE INVENTARIOPRODUCTOS 
        SET STOCK_ACTUAL = STOCK_ACTUAL + p_CANTIDAD 
        WHERE COD_PRODUCTO = p_CODIGO_PRODUCTO AND COD_SUCURSAL = p_COD_SUCURSAL_DESTINO;
    ELSE
        INSERT INTO INVENTARIOPRODUCTOS (COD_PRODUCTO, COD_SUCURSAL, STOCK_ACTUAL, STOCK_MINIMO, PRECIO_VENTA)
        VALUES (p_CODIGO_PRODUCTO, p_COD_SUCURSAL_DESTINO, p_CANTIDAD, 0, 0);
    END IF;

    -- Confirmar transacción
    SET MENSAJE = 'Traslado realizado correctamente';
    COMMIT;

END //

DELIMITER ;
CALL sp_RealizarTraslado('Sucursal Santa Lucia', 'Sucursal Plaza Miraflores', 'DANIELA-01', 10);
DROP PROCEDURE IF EXISTS sp_RealizarTraslado



-- LISTAR TRASLADOR 
DELIMITER //
CREATE PROCEDURE sp_ListarTraslados(
    IN p_COD_TRASLADO INT
)
BEGIN
    SELECT 
        T.COD_TRASLADO,
        SO.NOMBRE AS SUCURSAL_ORIGEN,
        SD.NOMBRE AS SUCURSAL_DESTINO,
        DT.COD_PRODUCTO,
        P.MODELO AS NOMBRE_PRODUCTO, -- Cambiado de NOMBRE_PRODUCTO a MODELO
        DT.CANTIDAD,
        T.FECHA_TRASLADO,
        T.ESTADO,
        T.NOTAS,
        U.NOMBRE_USUARIO AS USUARIO,
        CONCAT(E.PRIMER_NOMBRE_E, ' ', E.PRIMER_APELLIDO_E) AS EMPLEADO
    FROM TRASLADOS T
    INNER JOIN SUCURSALES SO ON T.SUCURSAL_ORIGEN = SO.COD_SUCURSAL
    INNER JOIN SUCURSALES SD ON T.SUCURSAL_DESTINO = SD.COD_SUCURSAL
    INNER JOIN DETALLETRASLADOS DT ON T.COD_TRASLADO = DT.COD_TRASLADO
    INNER JOIN PRODUCTOS P ON DT.COD_PRODUCTO = P.COD_PRODUCTO
    INNER JOIN USUARIOS U ON T.COD_USUARIO = U.COD_USUARIO
    INNER JOIN EMPLEADOS E ON U.COD_EMPLEADO = E.COD_EMPLEADO
    WHERE p_COD_TRASLADO IS NULL OR T.COD_TRASLADO = p_COD_TRASLADO;
END //
DELIMITER ;
CALL sp_ListarTraslados(NULL);

-- TABLA PARA DATOS DE LA EMPRESA
CREATE TABLE EMPRESA (
    COD_EMPRESA INT PRIMARY KEY AUTO_INCREMENT,
    RAZON_SOCIAL VARCHAR(100) NOT NULL,
    NOMBRE_COMERCIAL VARCHAR(50) NOT NULL,
    RTN VARCHAR(16) NOT NULL,
    DIRECCION VARCHAR(200) NOT NULL,
    CIUDAD VARCHAR(50) NOT NULL,
    DEPARTAMENTO VARCHAR(50) NOT NULL,
    TELEFONO VARCHAR(15) NOT NULL,
    EMAIL VARCHAR(50),
    SITIO_WEB VARCHAR(100),
    REGIMEN_FISCAL VARCHAR(50) NOT NULL,
    ACTIVIDAD_ECONOMICA VARCHAR(100) NOT NULL,
    LOGO LONGBLOB
);


-- TABLA PARA PUNTOS DE EMISIÓN
CREATE TABLE PUNTOS_EMISION (
    COD_PUNTO_EMISION INT PRIMARY KEY AUTO_INCREMENT,
    CODIGO VARCHAR(3) NOT NULL,
    NOMBRE VARCHAR(50) NOT NULL,
    ESTABLECIMIENTO VARCHAR(3) NOT NULL,
    -- DIRECCION VARCHAR(200) NOT NULL,
    -- TELEFONO VARCHAR(15),
    ESTADO ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO',
    COD_SUCURSAL INT,
    FOREIGN KEY (COD_SUCURSAL) REFERENCES SUCURSALES(COD_SUCURSAL)
);

-- TABLA PARA TIPOSpuntos_emision DE DOCUMENTO FISCAL
CREATE TABLE TIPOS_DOCUMENTO (
    COD_TIPO_DOCUMENTO INT PRIMARY KEY AUTO_INCREMENT,
    CODIGO VARCHAR(2) NOT NULL,
    NOMBRE VARCHAR(50) NOT NULL,
    DESCRIPCION VARCHAR(200),
    AFECTA_INVENTARIO BOOLEAN DEFAULT FALSE,
    REQUIERE_CLIENTE BOOLEAN DEFAULT TRUE,
    ESTADO ENUM('ACTIVO', 'INACTIVO') DEFAULT 'ACTIVO'
);

-- TABLA PARA CÓDIGOS DE AUTORIZACIÓN DE IMPRESIÓN (CAI)
CREATE TABLE CAI (
    COD_CAI INT PRIMARY KEY AUTO_INCREMENT,
    CODIGO_CAI VARCHAR(37) NOT NULL,
    FECHA_EMISION DATE NOT NULL,
    FECHA_VENCIMIENTO DATE NOT NULL,
    COD_TIPO_DOCUMENTO INT NOT NULL,
    COD_PUNTO_EMISION INT NOT NULL,
    ESTABLECIMIENTO VARCHAR(3) NOT NULL,
    PUNTO_EMISION_CODIGO VARCHAR(3) NOT NULL,
    TIPO_DOCUMENTO_CODIGO VARCHAR(2) NOT NULL,
    RANGO_INICIAL VARCHAR(8) NOT NULL,
    RANGO_FINAL VARCHAR(8) NOT NULL,
    RANGO_ACTUAL VARCHAR(8),
    ESTADO ENUM('ACTIVO', 'VENCIDO', 'ANULADO') DEFAULT 'ACTIVO',
    FOREIGN KEY (COD_TIPO_DOCUMENTO) REFERENCES TIPOS_DOCUMENTO(COD_TIPO_DOCUMENTO),
    FOREIGN KEY (COD_PUNTO_EMISION) REFERENCES PUNTOS_EMISION(COD_PUNTO_EMISION)
);

-- TABLA PARA CORRELATIVO DE DOCUMENTOS FISCALES
CREATE TABLE CORRELATIVOS (
    COD_CORRELATIVO INT PRIMARY KEY AUTO_INCREMENT,
    COD_CAI INT NOT NULL,
    PREFIJO VARCHAR(15) NOT NULL,
    ULTIMO_NUMERO INT NOT NULL DEFAULT 0,
    FECHA_ULTIMO_USO DATETIME,
    FOREIGN KEY (COD_CAI) REFERENCES CAI(COD_CAI)
);


-- TABLA FACTURAS DE VENTA DIRECTA (MODIFICADA)
CREATE TABLE FACTURASVENTA (
    COD_FACTURA INT PRIMARY KEY AUTO_INCREMENT,
    NUMERO_FACTURA VARCHAR(15) UNIQUE NOT NULL,
    COD_CLIENTE INT NULL,  -- Cliente puede ser NULL para ventas al contado
    COD_SUCURSAL INT NOT NULL,
    CAI VARCHAR(37) NULL,
    NUMERO_FISCAL VARCHAR(50) NULL,
    FECHA TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    SUBTOTAL DECIMAL(10,2) DEFAULT 0,
    IMPUESTO DECIMAL(10,2) DEFAULT 0,
    DESCUENTO DECIMAL(10,2) DEFAULT 0,
    TOTAL DECIMAL(10,2) GENERATED ALWAYS AS (SUBTOTAL - (SUBTOTAL * DESCUENTO) + ((SUBTOTAL - (SUBTOTAL * DESCUENTO)) * IMPUESTO)) STORED,
    METODO_PAGO ENUM('EFECTIVO', 'TARJETA', 'TRANSFERENCIA', 'OTRO') DEFAULT 'EFECTIVO',
    ESTADO ENUM('PENDIENTE', 'PAGADA', 'ANULADA') DEFAULT 'PENDIENTE',
    NOTAS TEXT NULL,
    FOREIGN KEY (COD_CLIENTE) REFERENCES CLIENTES(COD_CLIENTE),
    FOREIGN KEY (COD_SUCURSAL) REFERENCES SUCURSALES(COD_SUCURSAL)
);

-- TABLA DETALLE DE VENTA DIRECTA
CREATE TABLE DETALLEVENTA (
    COD_DETALLE_VENTA INT PRIMARY KEY AUTO_INCREMENT,
    COD_FACTURA INT NOT NULL,
    COD_PRODUCTO INT NOT NULL,
    CANTIDAD DECIMAL(10,2) NOT NULL,
    PRECIO DECIMAL(10,2) NOT NULL,
    SUBTOTAL DECIMAL(10,2) GENERATED ALWAYS AS (CANTIDAD * PRECIO) STORED,
    FOREIGN KEY (COD_FACTURA) REFERENCES FACTURASVENTA(COD_FACTURA),
    FOREIGN KEY (COD_PRODUCTO) REFERENCES PRODUCTOS(COD_PRODUCTO)
);
-- TABLA PEDIDOS DE CLIENTES
CREATE TABLE PEDIDOS (
    COD_PEDIDO INT PRIMARY KEY AUTO_INCREMENT,
    NUMERO_PEDIDO VARCHAR(15) UNIQUE NOT NULL,  -- Número de pedido personalizado
    COD_CLIENTE INT NOT NULL,
    COD_SUCURSAL INT NOT NULL,
    FECHA_PEDIDO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FECHA_ENTREGA DATE,
    ESTADO ENUM('PENDIENTE', 'EN PROCESO', 'COMPLETADO', 'CANCELADO') DEFAULT 'PENDIENTE',
    NOTAS VARCHAR(200),
    IMPUESTO DECIMAL(10,2) DEFAULT 0,
    DESCUENTO DECIMAL(10,2) DEFAULT 0,
    FOREIGN KEY (COD_CLIENTE) REFERENCES CLIENTES(COD_CLIENTE),
    FOREIGN KEY (COD_SUCURSAL) REFERENCES SUCURSALES(COD_SUCURSAL)
);
-- TABLA DETALLE DE PEDIDOS
CREATE TABLE DETALLEPEDIDOS (
    COD_DETALLE_PEDIDO INT PRIMARY KEY AUTO_INCREMENT,
    COD_PEDIDO INT NOT NULL,
    DESCRIPCION_PRODUCTO VARCHAR(200) NOT NULL,  -- Descripción del producto solicitado
    CANTIDAD DECIMAL(10,2) NOT NULL,            -- Cantidad solicitada
    PRECIO_UNITARIO DECIMAL(10,2) NOT NULL,     -- Precio unitario acordado
    SUBTOTAL DECIMAL(10,2) GENERATED ALWAYS AS (CANTIDAD * PRECIO_UNITARIO) STORED,
    FOREIGN KEY (COD_PEDIDO) REFERENCES PEDIDOS(COD_PEDIDO)
);
-- TABLA FACTURAS DE PEDIDOS (NUEVA)
CREATE TABLE FACTURASPEDIDO (
    COD_FACTURA INT PRIMARY KEY AUTO_INCREMENT,
    NUMERO_FACTURA VARCHAR(15) UNIQUE NOT NULL,
    COD_CLIENTE INT NOT NULL,
    COD_SUCURSAL INT NOT NULL,
    COD_PEDIDO INT NOT NULL,  -- Siempre asociada a un pedido
    CAI VARCHAR(37) NULL,
    NUMERO_FISCAL VARCHAR(50) NULL,
    FECHA TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    SUBTOTAL DECIMAL(10,2) DEFAULT 0,
    IMPUESTO DECIMAL(10,2) DEFAULT 0,
    DESCUENTO DECIMAL(10,2) DEFAULT 0,
    TOTAL DECIMAL(10,2) GENERATED ALWAYS AS (SUBTOTAL - (SUBTOTAL * DESCUENTO) + ((SUBTOTAL - (SUBTOTAL * DESCUENTO)) * IMPUESTO)) STORED,
    METODO_PAGO ENUM('EFECTIVO', 'TARJETA', 'TRANSFERENCIA', 'OTRO') DEFAULT 'EFECTIVO',
    ESTADO ENUM('PENDIENTE', 'PAGADA', 'ANULADA') DEFAULT 'PENDIENTE',
    FOREIGN KEY (COD_CLIENTE) REFERENCES CLIENTES(COD_CLIENTE),
    FOREIGN KEY (COD_SUCURSAL) REFERENCES SUCURSALES(COD_SUCURSAL),
    FOREIGN KEY (COD_PEDIDO) REFERENCES PEDIDOS(COD_PEDIDO)
);
-- TABLA DETALLE DE FACTURA DE PEDIDO (NUEVA)
CREATE TABLE DETALLESFACTURAPEDIDO (
    COD_DETALLE INT PRIMARY KEY AUTO_INCREMENT,
    COD_FACTURA INT NOT NULL,
    DESCRIPCION_PRODUCTO VARCHAR(200) NOT NULL,
    CANTIDAD DECIMAL(10,2) NOT NULL,
    PRECIO_UNITARIO DECIMAL(10,2) NOT NULL,
    SUBTOTAL DECIMAL(10,2) GENERATED ALWAYS AS (CANTIDAD * PRECIO_UNITARIO) STORED,
    COD_PRODUCTO INT NULL, -- Puede ser NULL si el producto no está en el catálogo
    FOREIGN KEY (COD_FACTURA) REFERENCES FACTURASPEDIDO(COD_FACTURA),
    FOREIGN KEY (COD_PRODUCTO) REFERENCES PRODUCTOS(COD_PRODUCTO)
);
-- TABLA GARANTIAS
CREATE TABLE GARANTIAS (
    COD_GARANTIA INT PRIMARY KEY AUTO_INCREMENT,
    COD_FACTURA_PEDIDO INT NULL,
    COD_FACTURA_VENTA INT NULL,
    COD_PRODUCTO INT NOT NULL,
    FECHA_INICIO DATE NOT NULL,
    FECHA_FIN DATE NOT NULL,
    ESTADO ENUM('ACTIVA', 'VENCIDA', 'APLICADA', 'CANCELADA') DEFAULT 'ACTIVA',
    DESCRIPCION VARCHAR(200),
    FOREIGN KEY (COD_FACTURA_PEDIDO) REFERENCES FACTURASPEDIDO(COD_FACTURA),
    FOREIGN KEY (COD_FACTURA_VENTA) REFERENCES FACTURASVENTA(COD_FACTURA),
    FOREIGN KEY (COD_PRODUCTO) REFERENCES PRODUCTOS(COD_PRODUCTO),
    CHECK (COD_FACTURA_PEDIDO IS NOT NULL OR COD_FACTURA_VENTA IS NOT NULL) -- Al menos uno debe tener valor
);
-- TABLA RECLAMOS DE GARANTIA
CREATE TABLE RECLAMOSGARANTIA (
    COD_RECLAMO INT PRIMARY KEY AUTO_INCREMENT,
    COD_GARANTIA INT NOT NULL,
    FECHA_RECLAMO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DESCRIPCION_PROBLEMA VARCHAR(200) NOT NULL,
    ESTADO ENUM('PENDIENTE', 'EN PROCESO', 'RESUELTO', 'RECHAZADO') DEFAULT 'PENDIENTE',
    SOLUCION VARCHAR(200),
    FECHA_SOLUCION DATE,
    FOREIGN KEY (COD_GARANTIA) REFERENCES GARANTIAS(COD_GARANTIA)
);

-- INSERTAR DATOS DE EMPRESA
DELIMITER //
CREATE PROCEDURE sp_InsertarEmpresa(
    IN p_razon_social VARCHAR(100),
    IN p_nombre_comercial VARCHAR(50),
    IN p_rtn VARCHAR(16),
    IN p_direccion VARCHAR(200),
    IN p_ciudad VARCHAR(50),
    IN p_departamento VARCHAR(50),
    IN p_telefono VARCHAR(15),
    IN p_email VARCHAR(50),
    IN p_sitio_web VARCHAR(100),
    IN p_regimen_fiscal VARCHAR(50),
    IN p_actividad_economica VARCHAR(100)
)
BEGIN
    INSERT INTO EMPRESA (
        RAZON_SOCIAL, 
        NOMBRE_COMERCIAL, 
        RTN, 
        DIRECCION, 
        CIUDAD, 
        DEPARTAMENTO, 
        TELEFONO, 
        EMAIL, 
        SITIO_WEB, 
        REGIMEN_FISCAL, 
        ACTIVIDAD_ECONOMICA
    ) VALUES (
        p_razon_social,
        p_nombre_comercial,
        p_rtn,
        p_direccion,
        p_ciudad,
        p_departamento,
        p_telefono,
        p_email,
        p_sitio_web,
        p_regimen_fiscal,
        p_actividad_economica
    );
    
    SELECT LAST_INSERT_ID() AS COD_EMPRESA;
END //
DELIMITER ;

-- Insertar datos de empresa
INSERT INTO EMPRESA (RAZON_SOCIAL, NOMBRE_COMERCIAL, RTN, DIRECCION, CIUDAD, DEPARTAMENTO, TELEFONO, EMAIL, SITIO_WEB, REGIMEN_FISCAL, ACTIVIDAD_ECONOMICA
) VALUES ('Danielas Leather','SIGAL','08019995123456','Santa Lucia, Honduras','Tegucigalpa','Francisco Morazán','+504 2234-5678','danielasleather@gmail.com','https://www.sigal.hn','Régimen de Facturación','Venta al por menor de artículos de cuero');


-- ACTUALIZAR DATOS DE EMPRESA
DELIMITER //
CREATE PROCEDURE sp_ActualizarEmpresa(
    IN p_cod_empresa INT,
    IN p_razon_social VARCHAR(100),
    IN p_nombre_comercial VARCHAR(50),
    IN p_rtn VARCHAR(16),
    IN p_direccion VARCHAR(200),
    IN p_ciudad VARCHAR(50),
    IN p_departamento VARCHAR(50),
    IN p_telefono VARCHAR(15),
    IN p_email VARCHAR(50),
    IN p_sitio_web VARCHAR(100),
    IN p_regimen_fiscal VARCHAR(50),
    IN p_actividad_economica VARCHAR(100)
)
BEGIN
    UPDATE EMPRESA SET
        RAZON_SOCIAL = p_razon_social,
        NOMBRE_COMERCIAL = p_nombre_comercial,
        RTN = p_rtn,
        DIRECCION = p_direccion,
        CIUDAD = p_ciudad,
        DEPARTAMENTO = p_departamento,
        TELEFONO = p_telefono,
        EMAIL = p_email,
        SITIO_WEB = p_sitio_web,
        REGIMEN_FISCAL = p_regimen_fiscal,
        ACTIVIDAD_ECONOMICA = p_actividad_economica
    WHERE COD_EMPRESA = p_cod_empresa;
    
    SELECT 'Datos de empresa actualizados correctamente' AS MENSAJE;
END //
DELIMITER ;

-- ACTUALIZAR LOGO DE EMPRESA
DELIMITER //
CREATE PROCEDURE sp_ActualizarLogoEmpresa(
    IN p_cod_empresa INT,
    IN p_logo LONGBLOB
)
BEGIN
    UPDATE EMPRESA SET
        LOGO = p_logo
    WHERE COD_EMPRESA = p_cod_empresa;
    
    SELECT 'Logo de empresa actualizado correctamente' AS MENSAJE;
END //
DELIMITER ;

-- OBTENER DATOS DE EMPRESA
DELIMITER //
CREATE PROCEDURE sp_ObtenerDatosEmpresa()
BEGIN
    SELECT * FROM EMPRESA LIMIT 1;
END //
DELIMITER ;

-- INSERTAR PUNTO DE EMISIÓN
DELIMITER //
CREATE PROCEDURE sp_InsertarPuntoEmision(
    IN p_codigo VARCHAR(3),
    IN p_nombre VARCHAR(50),
    IN p_establecimiento VARCHAR(3),
    -- IN p_direccion VARCHAR(200),
	-- IN p_telefono VARCHAR(15),
    IN p_cod_sucursal INT
)
BEGIN
    INSERT INTO PUNTOS_EMISION (
        CODIGO,
        NOMBRE,
        ESTABLECIMIENTO,
       -- DIRECCION,
       -- TELEFONO,
        COD_SUCURSAL
    ) VALUES (
        p_codigo,
        p_nombre,
        p_establecimiento,
     -- p_direccion,
	 -- p_telefono,
        p_cod_sucursal
    );
    
    SELECT LAST_INSERT_ID() AS COD_PUNTO_EMISION;
END //

DELIMITER ;

-- ACTUALIZAR PUNTO DE EMISIÓN
DELIMITER //
CREATE PROCEDURE sp_ActualizarPuntoEmision(
    IN p_cod_punto_emision INT,
    IN p_codigo VARCHAR(3),
    IN p_nombre VARCHAR(50),
    IN p_establecimiento VARCHAR(3),
    -- IN p_direccion VARCHAR(200),
   --  IN p_telefono VARCHAR(15),
    IN p_estado ENUM('ACTIVO', 'INACTIVO'),
    IN p_cod_sucursal INT
)
BEGIN
    UPDATE PUNTOS_EMISION SET
        CODIGO = p_codigo,
        NOMBRE = p_nombre,
        ESTABLECIMIENTO = p_establecimiento,
       -- DIRECCION = p_direccion,
       -- TELEFONO = p_telefono,
        ESTADO = p_estado,
        COD_SUCURSAL = p_cod_sucursal
    WHERE COD_PUNTO_EMISION = p_cod_punto_emision;
    
    SELECT 'Punto de emisión actualizado correctamente' AS MENSAJE;
END //
DELIMITER ;

-- LISTAR PUNTOS DE EMISIÓN
DELIMITER //
CREATE PROCEDURE sp_ListarPuntosEmision(
    IN p_estado ENUM('ACTIVO', 'INACTIVO')
)
BEGIN
    SELECT 
        PE.COD_PUNTO_EMISION,
        PE.CODIGO,
        PE.NOMBRE,
        PE.ESTABLECIMIENTO,
       -- PE.DIRECCION,
       -- PE.TELEFONO,
        PE.ESTADO,
        S.NOMBRE AS NOMBRE_SUCURSAL
    FROM PUNTOS_EMISION PE
    LEFT JOIN SUCURSALES S ON PE.COD_SUCURSAL = S.COD_SUCURSAL
    WHERE (p_estado IS NULL OR PE.ESTADO = p_estado)
    ORDER BY PE.CODIGO;
END //
DELIMITER ;

-- INSERTAR TIPO DE DOCUMENTO
DELIMITER //
CREATE PROCEDURE sp_InsertarTipoDocumento(
    IN p_codigo VARCHAR(2),
    IN p_nombre VARCHAR(50),
    IN p_descripcion VARCHAR(200),
    IN p_afecta_inventario BOOLEAN,
    IN p_requiere_cliente BOOLEAN
)
BEGIN
    INSERT INTO TIPOS_DOCUMENTO (
        CODIGO,
        NOMBRE,
        DESCRIPCION,
        AFECTA_INVENTARIO,
        REQUIERE_CLIENTE
    ) VALUES (
        p_codigo,
        p_nombre,
        p_descripcion,
        p_afecta_inventario,
        p_requiere_cliente
    );
    
    SELECT LAST_INSERT_ID() AS COD_TIPO_DOCUMENTO;
END //
DELIMITER ;


-- ACTUALIZAR TIPO DE DOCUMENTO
DELIMITER //
CREATE PROCEDURE sp_ActualizarTipoDocumento(
    IN p_cod_tipo_documento INT,
    IN p_codigo VARCHAR(2),
    IN p_nombre VARCHAR(50),
    IN p_descripcion VARCHAR(200),
    IN p_afecta_inventario BOOLEAN,
    IN p_requiere_cliente BOOLEAN,
    IN p_estado ENUM('ACTIVO', 'INACTIVO')
)
BEGIN
    UPDATE TIPOS_DOCUMENTO SET
        CODIGO = p_codigo,
        NOMBRE = p_nombre,
        DESCRIPCION = p_descripcion,
        AFECTA_INVENTARIO = p_afecta_inventario,
        REQUIERE_CLIENTE = p_requiere_cliente,
        ESTADO = p_estado
    WHERE COD_TIPO_DOCUMENTO = p_cod_tipo_documento;
    
    SELECT 'Tipo de documento actualizado correctamente' AS MENSAJE;
END //
DELIMITER ;

-- LISTAR TIPOS DE DOCUMENTO
DELIMITER //
CREATE PROCEDURE sp_ListarTiposDocumento(
    IN p_estado ENUM('ACTIVO', 'INACTIVO')
)
BEGIN
    SELECT 
        COD_TIPO_DOCUMENTO,
        CODIGO,
        NOMBRE,
        DESCRIPCION,
        AFECTA_INVENTARIO,
        REQUIERE_CLIENTE,
        ESTADO
    FROM TIPOS_DOCUMENTO
    WHERE (p_estado IS NULL OR ESTADO = p_estado)
    ORDER BY CODIGO;
END //
DELIMITER ;


-- INSERTAR CAI
DELIMITER //
CREATE PROCEDURE sp_InsertarCAI(
    IN p_codigo_cai VARCHAR(37),
    IN p_fecha_emision DATE,
    IN p_fecha_vencimiento DATE,
    IN p_cod_tipo_documento INT,
    IN p_cod_punto_emision INT,
    IN p_establecimiento VARCHAR(3),
    IN p_punto_emision_codigo VARCHAR(3),
    IN p_tipo_documento_codigo VARCHAR(2),
    IN p_rango_inicial VARCHAR(8),
    IN p_rango_final VARCHAR(8)
)
BEGIN
    DECLARE v_prefijo VARCHAR(15);
    DECLARE v_cod_cai INT;
    
    -- Validar que el CAI no exista ya para el mismo tipo de documento y punto de emisión
    SELECT COUNT(*) INTO @existe
    FROM CAI
    WHERE COD_TIPO_DOCUMENTO = p_cod_tipo_documento
    AND COD_PUNTO_EMISION = p_cod_punto_emision
    AND ESTADO = 'ACTIVO';
    
    IF @existe > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Ya existe un CAI activo para este tipo de documento y punto de emisión';
    END IF;
    
    -- Insertar el CAI
    INSERT INTO CAI (
        CODIGO_CAI,
        FECHA_EMISION,
        FECHA_VENCIMIENTO,
        COD_TIPO_DOCUMENTO,
        COD_PUNTO_EMISION,
        ESTABLECIMIENTO,
        PUNTO_EMISION_CODIGO,
        TIPO_DOCUMENTO_CODIGO,
        RANGO_INICIAL,
        RANGO_FINAL,
        RANGO_ACTUAL,
        ESTADO
    ) VALUES (
        p_codigo_cai,
        p_fecha_emision,
        p_fecha_vencimiento,
        p_cod_tipo_documento,
        p_cod_punto_emision,
        p_establecimiento,
        p_punto_emision_codigo,
        p_tipo_documento_codigo,
        p_rango_inicial,
        p_rango_final,
        p_rango_inicial,
        'ACTIVO'
    );
    
    SET v_cod_cai = LAST_INSERT_ID();
    
    -- Crear el prefijo para el correlativo
    SET v_prefijo = CONCAT(
        p_establecimiento,
        p_punto_emision_codigo,
        p_tipo_documento_codigo
    );
    
    -- Insertar el correlativo
    INSERT INTO CORRELATIVOS (
        COD_CAI,
        PREFIJO,
        ULTIMO_NUMERO
    ) VALUES (
        v_cod_cai,
        v_prefijo,
        CAST(p_rango_inicial AS UNSIGNED) - 1
    );
    
    SELECT v_cod_cai AS COD_CAI;
END //
DELIMITER ;


-- ACTUALIZAR CAI
DELIMITER //
CREATE PROCEDURE sp_ActualizarCAI(
    IN p_cod_cai INT,
    IN p_codigo_cai VARCHAR(37),
    IN p_fecha_emision DATE,
    IN p_fecha_vencimiento DATE,
    IN p_estado ENUM('ACTIVO', 'VENCIDO', 'ANULADO')
)
BEGIN
    UPDATE CAI SET
        CODIGO_CAI = p_codigo_cai,
        FECHA_EMISION = p_fecha_emision,
        FECHA_VENCIMIENTO = p_fecha_vencimiento,
        ESTADO = p_estado
    WHERE COD_CAI = p_cod_cai;
    
    SELECT 'CAI actualizado correctamente' AS MENSAJE;
END //
DELIMITER ;

-- LISTAR CAI
DELIMITER //
CREATE PROCEDURE sp_ListarCAI(
    IN p_estado ENUM('ACTIVO', 'VENCIDO', 'ANULADO')
)
BEGIN
    SELECT 
        C.COD_CAI,
        C.CODIGO_CAI,
        C.FECHA_EMISION,
        C.FECHA_VENCIMIENTO,
        TD.NOMBRE AS TIPO_DOCUMENTO,
        PE.NOMBRE AS PUNTO_EMISION,
        C.ESTABLECIMIENTO,
        C.PUNTO_EMISION_CODIGO,
        C.TIPO_DOCUMENTO_CODIGO,
        C.RANGO_INICIAL,
        C.RANGO_FINAL,
        C.RANGO_ACTUAL,
        C.ESTADO,
        CASE 
            WHEN CURDATE() > C.FECHA_VENCIMIENTO THEN 'VENCIDO'
            WHEN DATEDIFF(C.FECHA_VENCIMIENTO, CURDATE()) <= 30 THEN 'POR VENCER'
            ELSE 'VIGENTE'
        END AS ESTADO_VENCIMIENTO,
        DATEDIFF(C.FECHA_VENCIMIENTO, CURDATE()) AS DIAS_RESTANTES
    FROM CAI C
    JOIN TIPOS_DOCUMENTO TD ON C.COD_TIPO_DOCUMENTO = TD.COD_TIPO_DOCUMENTO
    JOIN PUNTOS_EMISION PE ON C.COD_PUNTO_EMISION = PE.COD_PUNTO_EMISION
    WHERE (p_estado IS NULL OR C.ESTADO = p_estado)
    ORDER BY C.FECHA_VENCIMIENTO;
END //
DELIMITER ;


-- OBTENER SIGUIENTE NUMERO DE DOCUMENTO
DELIMITER //
CREATE PROCEDURE sp_ObtenerSiguienteNumeroDocumento(
    IN p_cod_tipo_documento INT,
    IN p_cod_punto_emision INT,
    OUT p_numero_documento VARCHAR(50),
    OUT p_cai VARCHAR(37)
)
BEGIN
    DECLARE v_cod_cai INT;
    DECLARE v_prefijo VARCHAR(15);
    DECLARE v_ultimo_numero INT;
    DECLARE v_siguiente_numero INT;
    DECLARE v_rango_final INT;
    DECLARE v_numero_formateado VARCHAR(8);
    
    -- Obtener el CAI activo para el tipo de documento y punto de emisión
    SELECT 
        C.COD_CAI, 
        C.CODIGO_CAI,
        CAST(C.RANGO_FINAL AS UNSIGNED)
    INTO 
        v_cod_cai, 
        p_cai,
        v_rango_final
    FROM CAI C
    WHERE C.COD_TIPO_DOCUMENTO = p_cod_tipo_documento
    AND C.COD_PUNTO_EMISION = p_cod_punto_emision
    AND C.ESTADO = 'ACTIVO'
    AND CURDATE() BETWEEN C.FECHA_EMISION AND C.FECHA_VENCIMIENTO
    LIMIT 1;
    
    IF v_cod_cai IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'No existe un CAI activo para este tipo de documento y punto de emisión';
    END IF;
    
    -- Obtener el correlativo
    SELECT 
        PREFIJO,
        ULTIMO_NUMERO
    INTO 
        v_prefijo,
        v_ultimo_numero
    FROM CORRELATIVOS
    WHERE COD_CAI = v_cod_cai;
    
    -- Calcular el siguiente número
    SET v_siguiente_numero = v_ultimo_numero + 1;
    
    -- Verificar que no exceda el rango final
    IF v_siguiente_numero > v_rango_final THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Se ha alcanzado el límite del rango autorizado por el CAI';
    END IF;
    
    -- Formatear el número con ceros a la izquierda
    SET v_numero_formateado = LPAD(v_siguiente_numero, 8, '0');
    
    -- Actualizar el correlativo
    UPDATE CORRELATIVOS
    SET 
        ULTIMO_NUMERO = v_siguiente_numero,
        FECHA_ULTIMO_USO = NOW()
    WHERE COD_CAI = v_cod_cai;
    
    -- Actualizar el rango actual en el CAI
    UPDATE CAI
    SET RANGO_ACTUAL = v_numero_formateado
    WHERE COD_CAI = v_cod_cai;
    
    -- Devolver el número de documento completo
    SET p_numero_documento = CONCAT(v_prefijo, '-', v_numero_formateado);
END //
DELIMITER ;


-- PROCEDIMIENTO PARA GENERAR NÚMERO DE FACTURA
DELIMITER //
CREATE PROCEDURE sp_GenerarNumeroFacturaVenta(
    OUT p_numero_factura VARCHAR(15)
)
BEGIN
    DECLARE v_anio VARCHAR(4);
    DECLARE v_mes VARCHAR(2);
    DECLARE v_ultimo_numero INT;
    DECLARE v_prefijo VARCHAR(7);
    DECLARE v_nuevo_numero VARCHAR(8);
    
    -- Obtener año y mes actual para el prefijo
    SET v_anio = DATE_FORMAT(NOW(), '%Y');
    SET v_mes = DATE_FORMAT(NOW(), '%m');
    
    -- Crear prefijo con formato AAAAMM-
    SET v_prefijo = CONCAT(v_anio, v_mes, '-');
    
    -- Buscar el último número utilizado con este prefijo
    SELECT 
        IFNULL(
            MAX(
                CAST(
                    SUBSTRING_INDEX(NUMERO_FACTURA, '-', -1) AS UNSIGNED
                )
            ), 
            0
        ) INTO v_ultimo_numero
    FROM FACTURASVENTA
    WHERE NUMERO_FACTURA LIKE CONCAT(v_prefijo, '%');
    
    -- Incrementar el número
    SET v_ultimo_numero = v_ultimo_numero + 1;
    
    -- Formatear el nuevo número con ceros a la izquierda (8 dígitos)
    SET v_nuevo_numero = LPAD(v_ultimo_numero, 8, '0');
    
    -- Crear el número de factura completo
    SET p_numero_factura = CONCAT(v_prefijo, v_nuevo_numero);
    
    -- Verificar que no exista ya (por seguridad)
    SELECT COUNT(*) INTO @existe
    FROM FACTURASVENTA
    WHERE NUMERO_FACTURA = p_numero_factura;
    
    -- Si ya existe (muy improbable), incrementar y verificar de nuevo
    WHILE @existe > 0 DO
        SET v_ultimo_numero = v_ultimo_numero + 1;
        SET v_nuevo_numero = LPAD(v_ultimo_numero, 8, '0');
        SET p_numero_factura = CONCAT(v_prefijo, v_nuevo_numero);
        
        SELECT COUNT(*) INTO @existe
        FROM FACTURASVENTA
        WHERE NUMERO_FACTURA = p_numero_factura;
    END WHILE;
END //
DELIMITER ;

-- PROCEDIMIENTO PARA GENERAR FACTURA FISCAL
DELIMITER //
CREATE PROCEDURE sp_GenerarFacturaFiscal(
    IN p_cod_factura INT,
    IN p_tipo_factura ENUM('VENTA', 'PEDIDO'),
    IN p_cod_tipo_documento INT,
    IN p_cod_punto_emision INT
)
BEGIN
    DECLARE v_numero_fiscal VARCHAR(50);
    DECLARE v_cai VARCHAR(37);
    
    -- Obtener el siguiente número fiscal
    CALL sp_ObtenerSiguienteNumeroDocumento(
        p_cod_tipo_documento,
        p_cod_punto_emision,
        v_numero_fiscal,
        v_cai
    );
    
    -- Actualizar la factura con el número fiscal y CAI
    IF p_tipo_factura = 'VENTA' THEN
        UPDATE FACTURASVENTA
        SET 
            NUMERO_FISCAL = v_numero_fiscal,
            CAI = v_cai
        WHERE COD_FACTURA = p_cod_factura;
    ELSE
        UPDATE FACTURASPEDIDO
        SET 
            NUMERO_FISCAL = v_numero_fiscal,
            CAI = v_cai
        WHERE COD_FACTURA = p_cod_factura;
    END IF;
    
    SELECT 
        v_numero_fiscal AS NUMERO_FISCAL,
        v_cai AS CAI;
END //
DELIMITER ;
-- CREAR FACTURA DE VENTA CON CAI
DELIMITER //
CREATE PROCEDURE sp_CrearFacturaVentaConCAI(
    IN p_cod_cliente INT,                    -- Puede ser NULL para ventas al contado
    IN p_cod_sucursal INT,                   -- Sucursal donde se emite la factura
    IN p_cod_empleado INT,                   -- Empleado que realiza la venta
    IN p_impuesto DECIMAL(10,2),             -- Tasa de impuesto (ej: 0.15 para 15%)
    IN p_descuento DECIMAL(10,2),            -- Descuento general (ej: 0.05 para 5%)
    IN p_metodo_pago ENUM('EFECTIVO', 'TARJETA', 'TRANSFERENCIA', 'OTRO'),
    IN p_cod_tipo_documento INT,             -- Tipo de documento fiscal
    IN p_cod_punto_emision INT,              -- Punto de emisión
    OUT p_cod_factura INT,                   -- Código de factura generado
    OUT p_numero_factura VARCHAR(15),        -- Número de factura interno
    OUT p_numero_fiscal VARCHAR(50),         -- Número fiscal con formato CAI
    OUT p_cai VARCHAR(37)                    -- CAI utilizado
)
BEGIN
    DECLARE v_existe_cai INT DEFAULT 0;
    DECLARE v_numero_factura VARCHAR(15);
    
    -- Verificar que exista un CAI activo para el tipo de documento y punto de emisión
    SELECT COUNT(*) INTO v_existe_cai
    FROM CAI
    WHERE COD_TIPO_DOCUMENTO = p_cod_tipo_documento
    AND COD_PUNTO_EMISION = p_cod_punto_emision
    AND ESTADO = 'ACTIVO'
    AND CURDATE() BETWEEN FECHA_EMISION AND FECHA_VENCIMIENTO;
    
    IF v_existe_cai = 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: No existe un CAI activo para este tipo de documento y punto de emisión';
    END IF;
    
    -- Generar número de factura interno
    CALL sp_GenerarNumeroFacturaVenta(v_numero_factura);
    
    -- Insertar la factura en la tabla FACTURASVENTA
    INSERT INTO FACTURASVENTA(
        NUMERO_FACTURA, 
        COD_CLIENTE, 
        COD_SUCURSAL, 
        FECHA,
        SUBTOTAL,
        IMPUESTO, 
        DESCUENTO, 
        METODO_PAGO,
        ESTADO
    )
    VALUES(
        v_numero_factura, 
        p_cod_cliente, 
        p_cod_sucursal, 
        NOW(),
        0,
        p_impuesto, 
        p_descuento, 
        p_metodo_pago,
        'PENDIENTE'
    );
    
    -- Obtener el código de la factura recién insertada
    SET p_cod_factura = LAST_INSERT_ID();
    SET p_numero_factura = v_numero_factura;
    
    -- Generar el número fiscal y asignar CAI
    CALL sp_GenerarFacturaFiscal(
        p_cod_factura,
        'VENTA',
        p_cod_tipo_documento,
        p_cod_punto_emision
    );
    
    -- Obtener el número fiscal y CAI generados
    SELECT NUMERO_FISCAL, CAI INTO p_numero_fiscal, p_cai
    FROM FACTURASVENTA
    WHERE COD_FACTURA = p_cod_factura;
    
    -- Registrar el empleado que emitió la factura (si se tiene una tabla para esto)
    -- Esta parte depende de tu estructura, podrías agregar una columna COD_EMPLEADO a FACTURASVENTA
    -- o crear una tabla de auditoría
    
    -- Devolver información de la factura creada
    SELECT 
        p_cod_factura AS COD_FACTURA,
        p_numero_factura AS NUMERO_FACTURA,
        p_numero_fiscal AS NUMERO_FISCAL,
        p_cai AS CAI;
END //
DELIMITER ;

-- AGREGAR PRODUCTO A FACTURA DE VENTA
DELIMITER //
CREATE PROCEDURE sp_AgregarProductoFacturaVentaConCAI(
    IN p_cod_factura INT,                -- Código de la factura
    IN p_codigo_producto VARCHAR(15),    -- Código del producto
    IN p_cantidad DECIMAL(10,2),         -- Cantidad a vender
    IN p_precio_override DECIMAL(10,2)   -- Precio manual (NULL para usar precio de inventario)
)
BEGIN
    DECLARE v_cod_producto INT;
    DECLARE v_precio DECIMAL(10,2);
    DECLARE v_cod_sucursal INT;
    DECLARE v_stock_actual DECIMAL(10,2);
    DECLARE v_estado_factura VARCHAR(20);
    DECLARE v_subtotal_actual DECIMAL(10,2);
    DECLARE v_subtotal_nuevo DECIMAL(10,2);
    
    -- Verificar que la factura exista y esté en estado PENDIENTE
    SELECT ESTADO, COD_SUCURSAL, SUBTOTAL INTO v_estado_factura, v_cod_sucursal, v_subtotal_actual
    FROM FACTURASVENTA
    WHERE COD_FACTURA = p_cod_factura;
    
    IF v_estado_factura IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: La factura no existe';
    END IF;
    
    IF v_estado_factura != 'PENDIENTE' THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: La factura no está en estado PENDIENTE';
    END IF;
    
    -- Obtener el código del producto y su precio
    SELECT p.COD_PRODUCTO, COALESCE(i.PRECIO_VENTA, 0) 
    INTO v_cod_producto, v_precio
    FROM PRODUCTOS p
    JOIN INVENTARIOPRODUCTOS i ON p.COD_PRODUCTO = i.COD_PRODUCTO
    WHERE p.CODIGO = p_codigo_producto AND i.COD_SUCURSAL = v_cod_sucursal;
    
    IF v_cod_producto IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El producto no existe en esta sucursal';
    END IF;
    
    -- Usar precio override si se proporciona
    IF p_precio_override IS NOT NULL AND p_precio_override > 0 THEN
        SET v_precio = p_precio_override;
    END IF;
    
    -- Validar stock
    SELECT STOCK_ACTUAL INTO v_stock_actual
    FROM INVENTARIOPRODUCTOS
    WHERE COD_PRODUCTO = v_cod_producto AND COD_SUCURSAL = v_cod_sucursal;
    
    IF v_stock_actual < p_cantidad THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: Stock insuficiente';
    END IF;
    
    -- Verificar si el producto ya existe en la factura
    SELECT COUNT(*) INTO @existe_producto
    FROM DETALLEVENTA
    WHERE COD_FACTURA = p_cod_factura AND COD_PRODUCTO = v_cod_producto;
    
    IF @existe_producto > 0 THEN
        -- Actualizar cantidad y precio si ya existe
        UPDATE DETALLEVENTA
        SET CANTIDAD = CANTIDAD + p_cantidad,
            PRECIO = v_precio
        WHERE COD_FACTURA = p_cod_factura AND COD_PRODUCTO = v_cod_producto;
    ELSE
        -- Insertar en detalle de venta si es nuevo
        INSERT INTO DETALLEVENTA(COD_FACTURA, COD_PRODUCTO, CANTIDAD, PRECIO)
        VALUES(p_cod_factura, v_cod_producto, p_cantidad, v_precio);
    END IF;
    
    -- Calcular nuevo subtotal
    SELECT SUM(CANTIDAD * PRECIO) INTO v_subtotal_nuevo
    FROM DETALLEVENTA
    WHERE COD_FACTURA = p_cod_factura;
    
    -- Actualizar subtotal de la factura
    UPDATE FACTURASVENTA
    SET SUBTOTAL = v_subtotal_nuevo
    WHERE COD_FACTURA = p_cod_factura;
    
    -- No actualizamos el inventario todavía, eso se hará al finalizar la factura
    
    SELECT 
        'Producto agregado a la factura correctamente' AS MENSAJE,
        p_codigo_producto AS CODIGO_PRODUCTO,
        p_cantidad AS CANTIDAD,
        v_precio AS PRECIO_UNITARIO,
        (p_cantidad * v_precio) AS SUBTOTAL_LINEA,
        v_subtotal_nuevo AS SUBTOTAL_FACTURA;
END //
DELIMITER ;


-- FINALIZAR Y EMITIR FACTURA DE VENTA
DELIMITER //
CREATE PROCEDURE sp_FinalizarFacturaVenta(
    IN p_cod_factura INT,
    IN p_metodo_pago ENUM('EFECTIVO', 'TARJETA', 'TRANSFERENCIA', 'OTRO')
)
BEGIN
    DECLARE v_estado_factura VARCHAR(20);
    DECLARE v_cod_sucursal INT;
    DECLARE v_tiene_productos INT DEFAULT 0;
    
    -- Verificar que la factura exista y esté en estado PENDIENTE
    SELECT ESTADO, COD_SUCURSAL INTO v_estado_factura, v_cod_sucursal
    FROM FACTURASVENTA
    WHERE COD_FACTURA = p_cod_factura;
    
    IF v_estado_factura IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: La factura no existe';
    END IF;
    
    IF v_estado_factura != 'PENDIENTE' THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: La factura no está en estado PENDIENTE';
    END IF;
    
    -- Verificar que la factura tenga productos
    SELECT COUNT(*) INTO v_tiene_productos
    FROM DETALLEVENTA
    WHERE COD_FACTURA = p_cod_factura;
    
    IF v_tiene_productos = 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: La factura no tiene productos';
    END IF;
    
    -- Actualizar el método de pago si se proporciona
    IF p_metodo_pago IS NOT NULL THEN
        UPDATE FACTURASVENTA
        SET METODO_PAGO = p_metodo_pago
        WHERE COD_FACTURA = p_cod_factura;
    END IF;
    
    -- Actualizar estado de la factura a PAGADA
    UPDATE FACTURASVENTA
    SET ESTADO = 'PAGADA'
    WHERE COD_FACTURA = p_cod_factura;
    
    -- Actualizar inventario
    UPDATE INVENTARIOPRODUCTOS i
    JOIN DETALLEVENTA dv ON i.COD_PRODUCTO = dv.COD_PRODUCTO
    SET i.STOCK_ACTUAL = i.STOCK_ACTUAL - dv.CANTIDAD
    WHERE dv.COD_FACTURA = p_cod_factura AND i.COD_SUCURSAL = v_cod_sucursal;
    
    -- Generar garantías para los productos que apliquen
    INSERT INTO GARANTIAS(
        COD_FACTURA_PEDIDO, 
        COD_FACTURA_VENTA,
        COD_PRODUCTO, 
        FECHA_INICIO, 
        FECHA_FIN, 
        ESTADO, 
        DESCRIPCION
    )
    SELECT 
        NULL,
        p_cod_factura,
        dv.COD_PRODUCTO,
        CURDATE(),
        DATE_ADD(CURDATE(), INTERVAL p.TIEMPO_GARANTIA MONTH),
        'ACTIVA',
        CONCAT('Garantía por ', p.TIEMPO_GARANTIA, ' meses')
    FROM DETALLEVENTA dv
    JOIN PRODUCTOS p ON dv.COD_PRODUCTO = p.COD_PRODUCTO
    WHERE dv.COD_FACTURA = p_cod_factura AND p.TIEMPO_GARANTIA > 0;
    
    SELECT 'Factura finalizada y emitida correctamente' AS MENSAJE;
END //
DELIMITER ;


-- BUSCAR FACTURAS
DELIMITER //
CREATE PROCEDURE sp_BuscarFacturas(
    IN p_numero_factura VARCHAR(15),        -- Número interno de factura
    IN p_numero_fiscal VARCHAR(50),         -- Número fiscal con formato CAI
    IN p_nombre_cliente VARCHAR(100),       -- Nombre del cliente
    IN p_fecha_inicio DATE,                 -- Rango de fechas
    IN p_fecha_fin DATE,
    IN p_estado ENUM('PENDIENTE', 'PAGADA', 'ANULADA')
)
BEGIN
    SELECT 
        F.COD_FACTURA,
        F.NUMERO_FACTURA,
        F.NUMERO_FISCAL,
        F.CAI,
        DATE_FORMAT(F.FECHA, '%d/%m/%Y %H:%i:%s') AS FECHA,
        CASE 
            WHEN F.COD_CLIENTE IS NOT NULL THEN CONCAT(P.PRIMER_NOMBRE, ' ', P.PRIMER_APELLIDO)
            ELSE 'CONSUMIDOR FINAL'
        END AS NOMBRE_CLIENTE,
        S.NOMBRE AS SUCURSAL,
        F.SUBTOTAL,
        F.IMPUESTO,
        F.DESCUENTO,
        F.TOTAL,
        F.METODO_PAGO,
        F.ESTADO
    FROM FACTURASVENTA F
    LEFT JOIN CLIENTES C ON F.COD_CLIENTE = C.COD_CLIENTE
    LEFT JOIN PERSONAS P ON C.COD_PERSONA = P.COD_PERSONA
    JOIN SUCURSALES S ON F.COD_SUCURSAL = S.COD_SUCURSAL
    WHERE 
        (p_numero_factura IS NULL OR F.NUMERO_FACTURA LIKE CONCAT('%', p_numero_factura, '%')) AND
        (p_numero_fiscal IS NULL OR F.NUMERO_FISCAL LIKE CONCAT('%', p_numero_fiscal, '%')) AND
        (p_nombre_cliente IS NULL OR CONCAT(P.PRIMER_NOMBRE, ' ', P.PRIMER_APELLIDO) LIKE CONCAT('%', p_nombre_cliente, '%')) AND
        (p_fecha_inicio IS NULL OR F.FECHA >= p_fecha_inicio) AND
        (p_fecha_fin IS NULL OR F.FECHA <= DATE_ADD(p_fecha_fin, INTERVAL 1 DAY)) AND
        (p_estado IS NULL OR F.ESTADO = p_estado)
    ORDER BY F.FECHA DESC;
END //
DELIMITER ;

-- OBTENER DATOS PARA IMPRESIÓN DE FACTURA
DELIMITER //
CREATE PROCEDURE sp_ObtenerDatosImpresionFactura(
    IN p_cod_factura INT
)
BEGIN
    -- Datos de la empresa
    SELECT 'DATOS_EMPRESA' AS SECCION;
    SELECT 
        E.RAZON_SOCIAL,
        E.NOMBRE_COMERCIAL,
        E.RTN,
        E.DIRECCION,
        E.CIUDAD,
        E.DEPARTAMENTO,
        E.TELEFONO,
        E.EMAIL,
        E.SITIO_WEB,
        E.REGIMEN_FISCAL
    FROM EMPRESA E
    LIMIT 1;
    
    -- Datos de la factura
    SELECT 'DATOS_FACTURA' AS SECCION;
    SELECT 
        F.NUMERO_FACTURA,
        F.NUMERO_FISCAL,
        F.CAI,
        DATE_FORMAT(F.FECHA, '%d/%m/%Y %H:%i:%s') AS FECHA,
        S.NOMBRE AS SUCURSAL,
        S.DIRECCION AS DIRECCION_SUCURSAL,
        F.SUBTOTAL,
        F.IMPUESTO,
        CONCAT(F.IMPUESTO * 100, '%') AS PORCENTAJE_IMPUESTO,
        F.DESCUENTO,
        CONCAT(F.DESCUENTO * 100, '%') AS PORCENTAJE_DESCUENTO,
        F.TOTAL,
        F.METODO_PAGO,
        F.ESTADO
    FROM FACTURASVENTA F
    JOIN SUCURSALES S ON F.COD_SUCURSAL = S.COD_SUCURSAL
    WHERE F.COD_FACTURA = p_cod_factura;
    
    -- Datos del cliente
    SELECT 'DATOS_CLIENTE' AS SECCION;
    SELECT 
        CASE 
            WHEN F.COD_CLIENTE IS NOT NULL THEN CONCAT(P.PRIMER_NOMBRE, ' ', P.PRIMER_APELLIDO)
            ELSE 'CONSUMIDOR FINAL'
        END AS NOMBRE_CLIENTE,
        CASE 
            WHEN F.COD_CLIENTE IS NOT NULL THEN P.RTN
            ELSE 'CF'
        END AS RTN_CLIENTE
      --  CASE 
       --     WHEN F.COD_CLIENTE IS NOT NULL THEN 
        --        (SELECT DIRECCION FROM DIRECCIONES WHERE COD_PERSONA = P.COD_PERSONA LIMIT 1)
		-- ELSE ''
        -- END AS DIRECCION_CLIENTE,
       -- CASE 
        --    WHEN F.COD_CLIENTE IS NOT NULL THEN 
          --      (SELECT NUMERO_TELEFONO FROM TELEFONOS WHERE COD_PERSONA = P.COD_PERSONA LIMIT 1)
			-- ELSE ''
		-- END AS TELEFONO_CLIENTE
    FROM FACTURASVENTA F
    LEFT JOIN CLIENTES C ON F.COD_CLIENTE = C.COD_CLIENTE
    LEFT JOIN PERSONAS P ON C.COD_PERSONA = P.COD_PERSONA
    WHERE F.COD_FACTURA = p_cod_factura;
    
    -- Datos del CAI
    SELECT 'DATOS_CAI' AS SECCION;
    SELECT 
        C.CODIGO_CAI,
        DATE_FORMAT(C.FECHA_EMISION, '%d/%m/%Y') AS FECHA_EMISION,
        DATE_FORMAT(C.FECHA_VENCIMIENTO, '%d/%m/%Y') AS FECHA_VENCIMIENTO,
        CONCAT(C.ESTABLECIMIENTO, '-', C.PUNTO_EMISION_CODIGO, '-', C.TIPO_DOCUMENTO_CODIGO) AS PREFIJO,
        C.RANGO_INICIAL,
        C.RANGO_FINAL
    FROM CAI C
    JOIN FACTURASVENTA F ON F.CAI = C.CODIGO_CAI
    WHERE F.COD_FACTURA = p_cod_factura;
    
    -- Detalle de productos
    SELECT 'DETALLE_PRODUCTOS' AS SECCION;
    SELECT 
        P.CODIGO,
        P.MODELO,
        P.DESCRIPCION,
        DV.CANTIDAD,
        DV.PRECIO AS PRECIO_UNITARIO,
        DV.SUBTOTAL
    FROM DETALLEVENTA DV
    JOIN PRODUCTOS P ON DV.COD_PRODUCTO = P.COD_PRODUCTO
    WHERE DV.COD_FACTURA = p_cod_factura
    ORDER BY P.CODIGO;
    
    -- Totales
    SELECT 'TOTALES' AS SECCION;
    SELECT 
        F.SUBTOTAL,
        F.SUBTOTAL * F.DESCUENTO AS MONTO_DESCUENTO,
        (F.SUBTOTAL - (F.SUBTOTAL * F.DESCUENTO)) AS SUBTOTAL_NETO,
        (F.SUBTOTAL - (F.SUBTOTAL * F.DESCUENTO)) * F.IMPUESTO AS MONTO_IMPUESTO,
        F.TOTAL,
        CASE 
            WHEN F.METODO_PAGO = 'EFECTIVO' THEN 'EFECTIVO'
            WHEN F.METODO_PAGO = 'TARJETA' THEN 'TARJETA DE CRÉDITO/DÉBITO'
            WHEN F.METODO_PAGO = 'TRANSFERENCIA' THEN 'TRANSFERENCIA BANCARIA'
            ELSE F.METODO_PAGO
        END AS FORMA_PAGO
    FROM FACTURASVENTA F
    WHERE F.COD_FACTURA = p_cod_factura;
    
    -- Leyendas fiscales
    SELECT 'LEYENDAS_FISCALES' AS SECCION;
    SELECT 
        'LA FACTURA ES BENEFICIO DE TODOS, ¡EXÍJALA!' AS LEYENDA1,
        CONCAT('ORIGINAL: CLIENTE - COPIA: EMISOR - FECHA LÍMITE DE EMISIÓN: ', 
               DATE_FORMAT(C.FECHA_VENCIMIENTO, '%d/%m/%Y')) AS LEYENDA2,
        'ES CONTRIBUYENTE RESPONSABLE, RESOLUCIÓN XXXXXXXX' AS LEYENDA3
    FROM CAI C
    JOIN FACTURASVENTA F ON F.CAI = C.CODIGO_CAI
    WHERE F.COD_FACTURA = p_cod_factura;
END //
DELIMITER ;

-- ANULAR FACTURA DE VENTA
DELIMITER //
CREATE PROCEDURE sp_AnularFacturaVentaConCAI(
    IN p_cod_factura INT,
    IN p_motivo VARCHAR(200)
)
BEGIN
    DECLARE v_estado_factura VARCHAR(20);
    DECLARE v_cod_sucursal INT;
    
    -- Verificar que la factura exista
    SELECT ESTADO, COD_SUCURSAL INTO v_estado_factura, v_cod_sucursal
    FROM FACTURASVENTA
    WHERE COD_FACTURA = p_cod_factura;
    
    IF v_estado_factura IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: La factura no existe';
    END IF;
    
    IF v_estado_factura = 'ANULADA' THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: La factura ya está anulada';
    END IF;
    
    -- Anular garantías asociadas
    UPDATE GARANTIAS
    SET ESTADO = 'CANCELADA'
    WHERE COD_FACTURA_VENTA = p_cod_factura;
    
    -- Si la factura estaba PAGADA, devolver productos al inventario
    IF v_estado_factura = 'PAGADA' THEN
        UPDATE INVENTARIOPRODUCTOS i
        JOIN DETALLEVENTA dv ON i.COD_PRODUCTO = dv.COD_PRODUCTO
        SET i.STOCK_ACTUAL = i.STOCK_ACTUAL + dv.CANTIDAD
        WHERE dv.COD_FACTURA = p_cod_factura AND i.COD_SUCURSAL = v_cod_sucursal;
    END IF;
    
    -- Actualizar estado de la factura
    UPDATE FACTURASVENTA
    SET 
        ESTADO = 'ANULADA',
        NOTAS = CONCAT(IFNULL(NOTAS, ''), ' | Anulada: ', p_motivo)
    WHERE COD_FACTURA = p_cod_factura;
    
    SELECT 'Factura anulada correctamente' AS MENSAJE;
END //
DELIMITER ;


-- REPORTE DE VENTAS POR PERIODO
DELIMITER //
CREATE PROCEDURE sp_ReporteVentasPorPeriodo(
    IN p_fecha_inicio DATE,
    IN p_fecha_fin DATE,
    IN p_cod_sucursal INT
)
BEGIN
    -- Ventas diarias
    SELECT 'VENTAS_DIARIAS' AS SECCION;
    SELECT 
        DATE(F.FECHA) AS FECHA,
        COUNT(*) AS CANTIDAD_FACTURAS,
        SUM(F.SUBTOTAL) AS SUBTOTAL,
        SUM(F.TOTAL) AS TOTAL
    FROM FACTURASVENTA F
    WHERE 
        F.ESTADO = 'PAGADA' AND
        (p_fecha_inicio IS NULL OR F.FECHA >= p_fecha_inicio) AND
        (p_fecha_fin IS NULL OR F.FECHA <= DATE_ADD(p_fecha_fin, INTERVAL 1 DAY)) AND
        (p_cod_sucursal IS NULL OR F.COD_SUCURSAL = p_cod_sucursal)
    GROUP BY DATE(F.FECHA)
    ORDER BY DATE(F.FECHA);
    
    -- Ventas por sucursal
    SELECT 'VENTAS_POR_SUCURSAL' AS SECCION;
    SELECT 
        S.NOMBRE AS SUCURSAL,
        COUNT(*) AS CANTIDAD_FACTURAS,
        SUM(F.SUBTOTAL) AS SUBTOTAL,
        SUM(F.TOTAL) AS TOTAL
    FROM FACTURASVENTA F
    JOIN SUCURSALES S ON F.COD_SUCURSAL = S.COD_SUCURSAL
    WHERE 
        F.ESTADO = 'PAGADA' AND
        (p_fecha_inicio IS NULL OR F.FECHA >= p_fecha_inicio) AND
        (p_fecha_fin IS NULL OR F.FECHA <= DATE_ADD(p_fecha_fin, INTERVAL 1 DAY)) AND
        (p_cod_sucursal IS NULL OR F.COD_SUCURSAL = p_cod_sucursal)
    GROUP BY S.NOMBRE
    ORDER BY SUM(F.TOTAL) DESC;
    
    -- Ventas por método de pago
    SELECT 'VENTAS_POR_METODO_PAGO' AS SECCION;
    SELECT 
        F.METODO_PAGO,
        COUNT(*) AS CANTIDAD_FACTURAS,
        SUM(F.TOTAL) AS TOTAL
    FROM FACTURASVENTA F
    WHERE 
        F.ESTADO = 'PAGADA' AND
        (p_fecha_inicio IS NULL OR F.FECHA >= p_fecha_inicio) AND
        (p_fecha_fin IS NULL OR F.FECHA <= DATE_ADD(p_fecha_fin, INTERVAL 1 DAY)) AND
        (p_cod_sucursal IS NULL OR F.COD_SUCURSAL = p_cod_sucursal)
    GROUP BY F.METODO_PAGO
    ORDER BY SUM(F.TOTAL) DESC;
    
    -- Productos más vendidos
    SELECT 'PRODUCTOS_MAS_VENDIDOS' AS SECCION;
    SELECT 
        P.CODIGO,
        P.MODELO,
        P.DESCRIPCION,
        SUM(DV.CANTIDAD) AS CANTIDAD_TOTAL,
        SUM(DV.SUBTOTAL) AS TOTAL_VENDIDO
    FROM DETALLEVENTA DV
    JOIN PRODUCTOS P ON DV.COD_PRODUCTO = P.COD_PRODUCTO
    JOIN FACTURASVENTA F ON DV.COD_FACTURA = F.COD_FACTURA
    WHERE 
        F.ESTADO = 'PAGADA' AND
        (p_fecha_inicio IS NULL OR F.FECHA >= p_fecha_inicio) AND
        (p_fecha_fin IS NULL OR F.FECHA <= DATE_ADD(p_fecha_fin, INTERVAL 1 DAY)) AND
        (p_cod_sucursal IS NULL OR F.COD_SUCURSAL = p_cod_sucursal)
    GROUP BY P.CODIGO, P.MODELO, P.DESCRIPCION
    ORDER BY SUM(DV.CANTIDAD) DESC
    LIMIT 10;
    
    -- Resumen general
    SELECT 'RESUMEN_GENERAL' AS SECCION;
    SELECT 
        COUNT(*) AS TOTAL_FACTURAS,
        SUM(F.SUBTOTAL) AS SUBTOTAL_GENERAL,
        SUM(F.SUBTOTAL * F.DESCUENTO) AS DESCUENTOS_GENERAL,
        SUM((F.SUBTOTAL - (F.SUBTOTAL * F.DESCUENTO)) * F.IMPUESTO) AS IMPUESTOS_GENERAL,
        SUM(F.TOTAL) AS TOTAL_GENERAL,
        MIN(F.FECHA) AS PRIMERA_FACTURA,
        MAX(F.FECHA) AS ULTIMA_FACTURA
    FROM FACTURASVENTA F
    WHERE 
        F.ESTADO = 'PAGADA' AND
        (p_fecha_inicio IS NULL OR F.FECHA >= p_fecha_inicio) AND
        (p_fecha_fin IS NULL OR F.FECHA <= DATE_ADD(p_fecha_fin, INTERVAL 1 DAY)) AND
        (p_cod_sucursal IS NULL OR F.COD_SUCURSAL = p_cod_sucursal);
END //
DELIMITER ;




-- VERIFICAR ESTADO CAI
DELIMITER //
CREATE PROCEDURE sp_VerificarEstadoCAI()
BEGIN
    -- Actualizar CAIs vencidos
    UPDATE CAI
    SET ESTADO = 'VENCIDO'
    WHERE COD_CAI IN (
        SELECT COD_CAI 
        FROM CAI 
        WHERE FECHA_VENCIMIENTO < CURDATE() 
        AND ESTADO = 'ACTIVO'
    );
    
    -- Listar CAIs próximos a vencer (en los próximos 30 días)
    SELECT 
        C.COD_CAI,
        C.CODIGO_CAI,
        TD.NOMBRE AS TIPO_DOCUMENTO,
        PE.NOMBRE AS PUNTO_EMISION,
        C.FECHA_VENCIMIENTO,
        DATEDIFF(C.FECHA_VENCIMIENTO, CURDATE()) AS DIAS_RESTANTES
    FROM CAI C
    JOIN TIPOS_DOCUMENTO TD ON C.COD_TIPO_DOCUMENTO = TD.COD_TIPO_DOCUMENTO
    JOIN PUNTOS_EMISION PE ON C.COD_PUNTO_EMISION = PE.COD_PUNTO_EMISION
    WHERE C.ESTADO = 'ACTIVO'
    AND C.FECHA_VENCIMIENTO BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 30 DAY)
    ORDER BY C.FECHA_VENCIMIENTO;
END //
DELIMITER ;

-- ELIMINAR PRODUCTO DE FACTURA DE VENTA
DELIMITER //
CREATE PROCEDURE sp_EliminarProductoFacturaVenta(
    IN p_cod_factura INT,
    IN p_codigo_producto VARCHAR(15)
)
BEGIN
    DECLARE v_cod_producto INT;
    DECLARE v_estado_factura VARCHAR(20);
    DECLARE v_subtotal_nuevo DECIMAL(10,2);
    
    -- Verificar que la factura exista y esté en estado PENDIENTE
    SELECT ESTADO INTO v_estado_factura
    FROM FACTURASVENTA
    WHERE COD_FACTURA = p_cod_factura;
    
    IF v_estado_factura IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: La factura no existe';
    END IF;
    
    IF v_estado_factura != 'PENDIENTE' THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: La factura no está en estado PENDIENTE';
    END IF;
    
    -- Obtener el código del producto
    SELECT COD_PRODUCTO INTO v_cod_producto
    FROM PRODUCTOS
    WHERE CODIGO = p_codigo_producto;
    
    IF v_cod_producto IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: El producto no existe';
    END IF;
    
    -- Eliminar el producto de la factura
    DELETE FROM DETALLEVENTA
    WHERE COD_FACTURA = p_cod_factura AND COD_PRODUCTO = v_cod_producto;
    
    -- Calcular nuevo subtotal
    SELECT COALESCE(SUM(CANTIDAD * PRECIO), 0) INTO v_subtotal_nuevo
    FROM DETALLEVENTA
    WHERE COD_FACTURA = p_cod_factura;
    
    -- Actualizar subtotal de la factura
    UPDATE FACTURASVENTA
    SET SUBTOTAL = v_subtotal_nuevo
    WHERE COD_FACTURA = p_cod_factura;
    
    SELECT 
        'Producto eliminado de la factura correctamente' AS MENSAJE,
        v_subtotal_nuevo AS SUBTOTAL_FACTURA;
END //
DELIMITER ;



CREATE TABLE `sessions` (
    `id` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL PRIMARY KEY,
    `user_id` int(10) unsigned DEFAULT NULL,
    `ip_address` varchar(45) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
    `user_agent` text COLLATE utf8mb4_unicode_ci,
    `payload` longtext COLLATE utf8mb4_unicode_ci NOT NULL,
    `last_activity` int(10) unsigned NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

Call sp_InsertarCAI('31FB52-15D54C-F54E8F-1D54F8-A54F87-1C', '2025-03-29','2026-03-29',1, 1, '001', 
    '001', -- PUNTO_EMISION_CODIGO
    '01', -- TIPO_DOCUMENTO_CODIGO
    '00000001', -- RANGO_INICIAL
    '00001000' 
);


SHOW CREATE TABLE OBJETOS;
SHOW CREATE TABLE ACCESOS;

INSERT INTO OBJETOS (NOMBRE_OBJETO, TIPO_OBJETO, DESCRIPCION_OBJETO) VALUES
('Pantalla', 'Pantalla', 'Gestion de Pantallas del sistema');
('Roles', 'Pantalla', 'Gestion de roles');
('Materiales', 'Pantalla', 'Gestion de materiales');
('Dashboard', 'Pantalla', 'Panel principal'),
('Usuarios', 'Pantalla', 'Gestión de usuarios'),
('Clientes', 'Pantalla', 'Gestión de clientes');


INSERT INTO ACCESOS (COD_ROL, COD_OBJETO, ESTADO_MODULO, ESTADO_SELECCION) VALUES
(1, 1, '1', '1'), -- Rol 1 tiene acceso a Dashboard
(1, 2, '1', '0'), -- Rol 1 no tiene acceso a Usuarios
(2, 2, '1', '1'); -- Rol 2 tiene acceso a Usuarios


INSERT INTO ROLES (NOMBRE_ROL, DESCRIPCION_ROL, ESTADO_ROL, USUARIO_CREA) VALUES
('Usuario', 'Acceso limitado al sistema', '1', 'admin');

INSERT INTO ACCESOS (COD_ROL, COD_OBJETO, ESTADO_MODULO, ESTADO_SELECCION) VALUES
(1, 2, '1', '1'),
(1, 3, '1', '0'),
(2, 3, '1', '1');

SELECT * FROM ACCESOS;

INSERT INTO ACCESOS (COD_ROL, COD_OBJETO, ESTADO_MODULO, ESTADO_SELECCION) VALUES
(2, 2, '1', '1'); -- Permitir Dashboard a COD_ROL = 2

SELECT * FROM usuarios;
SELECT * FROM OBJETOS;
INSERT INTO ROLES (NOMBRE_ROL, DESCRIPCION_ROL, ESTADO_ROL, USUARIO_CREA) VALUES
('SuperAdmin', 'Acceso completo para Ozuniga', '1', 'admin');

SELECT * FROM ROLES;


INSERT INTO ACCESOS (COD_ROL, COD_OBJETO, ESTADO_MODULO, ESTADO_SELECCION, ESTADO_INSERCION, ESTADO_ACTUALIZACION, ESTADO_ELIMINACION) VALUES
(3, 1, '1', '1', '1', '1', '1'), -- Modulo de Usuarios
(3, 2, '1', '1', '1', '1', '1'), -- Dashboard
(3, 3, '1', '1', '1', '1', '1'), -- Usuarios
(3, 4, '1', '1', '1', '1', '1'); -- Clientes


INSERT INTO ACCESOS (COD_ROL, COD_OBJETO, ESTADO_MODULO, ESTADO_SELECCION, ESTADO_INSERCION, ESTADO_ACTUALIZACION, ESTADO_ELIMINACION) VALUES
(3, 9, '1', '1', '1', '1', '1'); -- Modulo de Usuarios
SELECT * FROM OBJETOS WHERE NOMBRE_OBJETO = 'Roles';
SELECT COD_OBJETO
FROM OBJETOS
WHERE NOMBRE_OBJETO = 'Clientes';
SELECT * FROM ACCESOS WHERE COD_ROL = 3 AND COD_OBJETO = 4;
UPDATE ACCESOS
SET ESTADO_INSERCION = '1'
WHERE COD_ROL = 3
AND COD_OBJETO = 7;
select*from objetos
UPDATE USUARIOS SET COD_ROL = 3 WHERE COD_USUARIO = 1 ;

DESCRIBE ACCESOS;
select*from accesos

DELIMITER //
CREATE PROCEDURE sp_ListarAccesosPorRol(
    IN P_COD_ROL BIGINT
)
BEGIN
    SELECT a.*, o.NOMBRE_OBJETO
    FROM ACCESOS a
    JOIN OBJETOS o ON a.COD_OBJETO = o.COD_OBJETO
    WHERE a.COD_ROL = P_COD_ROL;
END//
DELIMITER ;

